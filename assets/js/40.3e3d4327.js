(window.webpackJsonp=window.webpackJsonp||[]).push([[40],{645:function(t,s,a){"use strict";a.r(s);var n=a(6),r=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"grpc中的tls认证"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#grpc中的tls认证"}},[t._v("#")]),t._v(" gRPC中的TLS认证")]),t._v(" "),a("h2",{attrs:{id:"_1-介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-介绍"}},[t._v("#")]),t._v(" 1. 介绍")]),t._v(" "),a("p",[a("code",[t._v("gRPC")]),t._v("建立在"),a("code",[t._v("HTTP/2")]),t._v("协议之上，对"),a("code",[t._v("TLS")]),t._v("提供了很好的支持。当不需要证书认证时,可通过"),a("code",[t._v("grpc.WithInsecure()")]),t._v("选项跳过了对服务器证书的验证，没有启用证书的"),a("code",[t._v("gRPC")]),t._v("服务和客户端进行的是明文通信，信息面临被任何第三方监听的风险。为了保证"),a("code",[t._v("gRPC")]),t._v("通信不被第三方监听、篡改或伪造，可以对服务器启动"),a("code",[t._v("TLS")]),t._v("加密特性。")]),t._v(" "),a("h2",{attrs:{id:"_2-概念简述"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-概念简述"}},[t._v("#")]),t._v(" 2. 概念简述")]),t._v(" "),a("h3",{attrs:{id:"_2-1-什么是ca"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-1-什么是ca"}},[t._v("#")]),t._v(" 2.1 什么是CA")]),t._v(" "),a("p",[a("code",[t._v("CA")]),t._v("是"),a("code",[t._v("Certificate Authority")]),t._v("的缩写，也叫“证书授权中心”。它是负责管理和签发证书的第三方机构，作用是检查证书持有者身份的合法性，并签发证书，以防证书被伪造或篡改。")]),t._v(" "),a("blockquote",[a("p",[a("code",[t._v("CA")]),t._v("实际上是一个机构，负责“证件”印制核发。就像负责颁发身份证的公安局、负责发放行驶证、驾驶证的车管所。")])]),t._v(" "),a("h3",{attrs:{id:"_2-2-什么是ca证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-2-什么是ca证书"}},[t._v("#")]),t._v(" 2.2 什么是CA证书")]),t._v(" "),a("p",[a("code",[t._v("CA")]),t._v(" 证书就是"),a("code",[t._v("CA")]),t._v("颁发的证书。我们常听到的数字证书就是"),a("code",[t._v("CA证书")]),t._v(","),a("code",[t._v("CA证书")]),t._v("包含信息有:"),a("strong",[t._v("证书拥有者的身份信息，CA机构的签名，公钥和私钥")]),t._v(",")]),t._v(" "),a("ul",[a("li",[t._v("身份信息: 用于证明证书持有者的身份")]),t._v(" "),a("li",[t._v("CA机构的签名: 用于保证身份的真实性")]),t._v(" "),a("li",[t._v("公钥和私钥: 用于通信过程中加解密，从而保证通讯信息的安全性")])]),t._v(" "),a("h3",{attrs:{id:"_2-3-什么是san"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-3-什么是san"}},[t._v("#")]),t._v(" 2.3 什么是"),a("code",[t._v("SAN")])]),t._v(" "),a("p",[a("code",[t._v("SAN(Subject Alternative Name)")]),t._v("是 "),a("code",[t._v("SSL")]),t._v(" 标准 "),a("code",[t._v("x509")]),t._v(" 中定义的一个扩展。使用了 "),a("code",[t._v("SAN")]),t._v(" 字段的 "),a("code",[t._v("SSL")]),t._v(" 证书，可以扩展此证书支持的域名，使得一个证书可以支持多个不同域名的解析。")]),t._v(" "),a("h3",{attrs:{id:"_2-4-为什么需要san"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-4-为什么需要san"}},[t._v("#")]),t._v(" 2.4 为什么需要"),a("code",[t._v("SAN")])]),t._v(" "),a("p",[t._v("先看下不通过"),a("code",[t._v("SAN")]),t._v("生成的证书，会报的错误信息。")]),t._v(" "),a("blockquote",[a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("rpc "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Unavailable desc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" connection "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" desc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transport: authentication handshake failed: x509: certificate relies on legacy Common Name field, use SANs or temporarily enable Common Name matching with GODEBUG=x509ignoreCN=0"')]),t._v("\n")])])])]),t._v(" "),a("p",[t._v("出现上述错误，原因是因为 从go 1.15 版本开始"),a("a",{attrs:{href:"https://golang.org/doc/go1.15#commonname",target:"_blank",rel:"noopener noreferrer"}},[t._v("废弃 CommonName"),a("OutboundLink")],1),t._v("，因此推荐使用 SAN 证书。")]),t._v(" "),a("h2",{attrs:{id:"_3-证书生成流程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-证书生成流程"}},[t._v("#")]),t._v(" 3. 证书生成流程")]),t._v(" "),a("h3",{attrs:{id:"_3-1-生成ca证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-生成ca证书"}},[t._v("#")]),t._v(" 3.1 生成CA证书")]),t._v(" "),a("h4",{attrs:{id:"_1-新增ca-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-新增ca-conf"}},[t._v("#")]),t._v(" 1. 新增"),a("code",[t._v("ca.conf")])]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" req "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\ndefault_bits       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),t._v("\ndistinguished_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" req_distinguished_name\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" req_distinguished_name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\ncountryName                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" GB\ncountryName_default         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" BeiJing\nstateOrProvinceName         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" State or Province Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("full name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nstateOrProvinceName_default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" JiangSu\nlocalityName                "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Locality Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" city"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nlocalityName_default        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NanJing\norganizationName            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Organization Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" company"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\norganizationName_default    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Step\ncommonName                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" liuqh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("icu\ncommonName_max              "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\ncommonName_default          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" liuqh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("icu\n")])])]),a("h4",{attrs:{id:"_2-生成ca私钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成ca私钥"}},[t._v("#")]),t._v(" 2. 生成CA私钥")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("# 生成CA私钥\n$ openssl genrsa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("4096")]),t._v("\n")])])]),a("h4",{attrs:{id:"_3-生成ca证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-生成ca证书"}},[t._v("#")]),t._v(" 3. 生成CA证书")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("$ openssl req "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("x509 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("days "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("365")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("subj "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/C=GB/L=Beijing/O=github/CN=liuqh.icu"')]),t._v(" \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("key ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("config ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf\n")])])]),a("ul",[a("li",[a("code",[t._v("C=GB")]),t._v(": "),a("code",[t._v("C")]),t._v("代表的是国家名称代码。")]),t._v(" "),a("li",[a("code",[t._v("L=Beijing")]),t._v(": 代表地方名称,例如城市。")]),t._v(" "),a("li",[a("code",[t._v("O=gobook")]),t._v(": 代表组织单位名称。")]),t._v(" "),a("li",[a("code",[t._v("CN=liuqh.icu")]),t._v(": 代表关联的域名，")])]),t._v(" "),a("blockquote",[a("p",[a("a",{attrs:{href:"https://www.digicert.com/kb/ssl-support/openssl-quick-reference-guide.htm#CreatingYourCSR",target:"_blank",rel:"noopener noreferrer"}},[t._v("更多参数含义:https://www.digicert.com/kb/ssl-support/openssl-quick-reference-guide.htm#CreatingYourCSR"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"_3-2-生成服务端证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-生成服务端证书"}},[t._v("#")]),t._v(" 3.2 生成服务端证书")]),t._v(" "),a("h4",{attrs:{id:"_1-新增server-conf"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-新增server-conf"}},[t._v("#")]),t._v(" 1. 新增"),a("code",[t._v("server.conf")])]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" req "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\ndefault_bits       "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v("\ndistinguished_name "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" req_distinguished_name\n\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" req_distinguished_name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\ncountryName                 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Country Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),t._v(" letter code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncountryName_default         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" CN\nstateOrProvinceName         "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" State or Province Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("full name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nstateOrProvinceName_default "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" JiangSu\nlocalityName                "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Locality Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" city"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\nlocalityName_default        "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" NanJing\norganizationName            "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Organization Name "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("eg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" company"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\norganizationName_default    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Step\ncommonName                  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" CommonName "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("g"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v(" server FQDN or YOUR name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\ncommonName_max              "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("\ncommonName_default          "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("XXX")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("自定义"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("客户端需要此字段做匹配"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" req_ext "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nsubjectAltName "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" @alt_names\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("alt_names"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\nDNS"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" liuqh"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("icu\nIP      "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("127.0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".0")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v(".1")]),t._v("\n")])])]),a("h4",{attrs:{id:"_2-生成公私钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成公私钥"}},[t._v("#")]),t._v(" 2.生成公私钥")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("$ openssl genrsa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v("\n")])])]),a("h4",{attrs:{id:"_3-生成csr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-生成csr"}},[t._v("#")]),t._v(" 3. 生成"),a("code",[t._v("CSR")])]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("$ openssl req "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("new")]),t._v("  "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("subj "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/C=GB/L=Beijing/O=github/CN=liuqh.icu"')]),t._v(" \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("key server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("csr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("config server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf\n")])])]),a("h4",{attrs:{id:"_4-基于ca签发证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-基于ca签发证书"}},[t._v("#")]),t._v(" 4. 基于CA签发证书")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("$ openssl x509 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("req "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("sha256 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("CA ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("CAkey ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("CAcreateserial "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("days "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("365")]),t._v(" \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("in server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("csr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("extensions req_ext "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("extfile server"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("conf\n")])])]),a("h3",{attrs:{id:"_3-4-生成客户端证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-4-生成客户端证书"}},[t._v("#")]),t._v(" 3.4 生成客户端证书")]),t._v(" "),a("h4",{attrs:{id:"_1-生成公私钥"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-生成公私钥"}},[t._v("#")]),t._v(" 1. 生成公私钥")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("$ openssl genrsa "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("2048")]),t._v("\n")])])]),a("h4",{attrs:{id:"_2-生成csr"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-生成csr"}},[t._v("#")]),t._v(" 2. 生成"),a("code",[t._v("CSR")])]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("$ openssl req "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("new")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("subj "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"/C=GB/L=Beijing/O=github/CN=liuqh.icu"')]),t._v("  \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("key client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("csr \n")])])]),a("h4",{attrs:{id:"_3-基于ca签发证书"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-基于ca签发证书"}},[t._v("#")]),t._v(" 3.基于CA签发证书")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("$ openssl x509 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("req "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("sha256 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("CA ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("CAkey ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("key "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("CAcreateserial "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("days "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("365")]),t._v(" \\\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("in client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("csr "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v("out client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("crt\n")])])]),a("h2",{attrs:{id:"_4-目录结构"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-目录结构"}},[t._v("#")]),t._v(" 4. 目录结构")]),t._v(" "),a("h2",{attrs:{id:"_5-代码实现"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-代码实现"}},[t._v("#")]),t._v(" 5.代码实现")]),t._v(" "),a("h3",{attrs:{id:"_5-1-服务端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-1-服务端"}},[t._v("#")]),t._v(" 5.1 服务端")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"52lu/go-rpc/server/tslservice"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"crypto/tls"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"crypto/x509"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"google.golang.org/grpc"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"google.golang.org/grpc/credentials"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io/ioutil"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"net"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 公钥中读取和解析公钥/私钥对")]),t._v("\n\tpair"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LoadX509KeyPair")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./pem/server.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./pem/server.key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"LoadX509KeyPair error"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建一组根证书")]),t._v("\n\tcertPool "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" x509"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewCertPool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" ioutil"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ReadFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./pem/ca.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"read ca pem error "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 解析证书")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ok "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" certPool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AppendCertsFromPEM")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ok "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"AppendCertsFromPEM error "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tcred "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTLS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tCertificates"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Certificate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("pair"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tClientAuth"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("   tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("RequireAndVerifyClientCert"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tClientCAs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    certPool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tgrpcServer "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Creds")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cred"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 注册服务")]),t._v("\n\ttslservice"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("RegisterTslServiceServer")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("grpcServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("tslservice"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnimplementedTslServiceServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 监听端口")]),t._v("\n\tlisten"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" net"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Listen")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"tcp"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('":1234"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"服务启动成功...."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 启动服务")]),t._v("\n\tgrpcServer"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Serve")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("listen"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_5-2-客户端"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-2-客户端"}},[t._v("#")]),t._v(" 5.2 客户端")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" main\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("import")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"52lu/go-rpc/server/tslservice"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"context"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"crypto/tls"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"crypto/x509"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"fmt"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"google.golang.org/grpc"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"google.golang.org/grpc/credentials"')]),t._v("\n\twrapperspb "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"google.golang.org/protobuf/types/known/wrapperspb"')]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"io/ioutil"')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("func")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 公钥中读取和解析公钥/私钥对")]),t._v("\n\tpair"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("LoadX509KeyPair")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./pem/client.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./pem/client.key"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"LoadX509KeyPair error "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 创建一组根证书")]),t._v("\n\tcertPool "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" x509"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewCertPool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" ioutil"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("ReadFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"./pem/ca.crt"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"ReadFile ca.crt error "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 解析证书")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" ok "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" certPool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("AppendCertsFromPEM")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("ca"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("ok "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"certPool.AppendCertsFromPEM error "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\tcred "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" credentials"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTLS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Config"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tCertificates"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("tls"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Certificate"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("pair"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('//ServerName:   "liuqh.icu",')]),t._v("\n\t\tServerName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"test.com"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t\tRootCAs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("    certPool"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tconn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Dial")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('":1234"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" grpc"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("WithTransportCredentials")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("cred"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\t\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"dial error "')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("defer")]),t._v(" conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Close")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\t"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 实例化客户端")]),t._v("\n\tclient "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" tslservice"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("NewTslServiceClient")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("conn"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\ttest"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(":=")]),t._v(" client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("context"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("TODO")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&")]),t._v("wrapperspb"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("Int32Value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("Value"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"res:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\tfmt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("Println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"err:"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" err"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),a("h3",{attrs:{id:"_5-3-发起请求"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_5-3-发起请求"}},[t._v("#")]),t._v(" 5.3 发起请求")]),t._v(" "),a("div",{staticClass:"language-go extra-class"},[a("pre",{pre:!0,attrs:{class:"language-go"}},[a("code",[t._v("# 证书正常时\n$ "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" run client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v("\nres"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" code"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("200")]),t._v(" msg"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"success"')]),t._v("\nerr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\n\n# 故意写错客户端中的 ServerName"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("test"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("com\n$  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v(" run client"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("go")]),t._v("\nres"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v("\nerr"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" rpc "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" code "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Unavailable desc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" connection "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" desc "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"transport: authentication handshake failed: x509: certificate is valid for liuqh.icu, not test.com"')]),t._v("\n")])])]),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"http://liuqh.icu/2022/02/23/go/rpc/06-tls/",target:"_blank",rel:"noopener noreferrer"}},[t._v("RPC编程(六):gRPC中的TLS认证"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=r.exports}}]);
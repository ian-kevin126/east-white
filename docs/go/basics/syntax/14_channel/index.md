---
title: Channel
author: ian_kevin
date: 2022-04-19
---

# Channel

## ä¸€ã€channelç®€ä»‹

å•çº¯åœ°å°†å‡½æ•°å¹¶å‘æ‰§è¡Œæ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚å‡½æ•°ä¸å‡½æ•°é—´éœ€è¦äº¤æ¢æ•°æ®æ‰èƒ½ä½“ç°å¹¶å‘æ‰§è¡Œå‡½æ•°çš„æ„ä¹‰ã€‚

è™½ç„¶å¯ä»¥ä½¿ç”¨å…±äº«å†…å­˜è¿›è¡Œæ•°æ®äº¤æ¢ï¼Œä½†æ˜¯å…±äº«å†…å­˜åœ¨ä¸åŒçš„ goroutine ä¸­å®¹æ˜“å‘ç”Ÿç«æ€é—®é¢˜ã€‚ä¸ºäº†ä¿è¯æ•°æ®äº¤æ¢çš„æ­£ç¡®æ€§ï¼Œå¾ˆå¤šå¹¶å‘æ¨¡å‹ä¸­å¿…é¡»ä½¿ç”¨äº’æ–¥é‡å¯¹å†…å­˜è¿›è¡ŒåŠ é”ï¼Œè¿™ç§åšæ³•åŠ¿å¿…é€ æˆæ€§èƒ½é—®é¢˜ã€‚

Goè¯­è¨€é‡‡ç”¨çš„å¹¶å‘æ¨¡å‹æ˜¯`CSPï¼ˆCommunicating Sequential Processesï¼‰`ï¼Œæå€¡**é€šè¿‡é€šä¿¡å…±äº«å†…å­˜**è€Œä¸æ˜¯**é€šè¿‡å…±äº«å†…å­˜è€Œå®ç°é€šä¿¡**ã€‚

å¦‚æœè¯´ goroutine æ˜¯Goç¨‹åºå¹¶å‘çš„æ‰§è¡Œä½“ï¼Œ`channel`å°±æ˜¯å®ƒä»¬ä¹‹é—´çš„è¿æ¥ã€‚`channel`æ˜¯å¯ä»¥è®©ä¸€ä¸ª `goroutine` å‘é€ç‰¹å®šå€¼åˆ°å¦ä¸€ä¸ª goroutine çš„é€šä¿¡æœºåˆ¶ã€‚

Go è¯­è¨€ä¸­çš„é€šé“ï¼ˆchannelï¼‰æ˜¯ä¸€ç§ç‰¹æ®Šçš„ç±»å‹ã€‚é€šé“åƒä¸€ä¸ªä¼ é€å¸¦æˆ–è€…é˜Ÿåˆ—ï¼Œæ€»æ˜¯éµå¾ªå…ˆå…¥å…ˆå‡ºï¼ˆFirst In First Outï¼‰çš„è§„åˆ™ï¼Œä¿è¯æ”¶å‘æ•°æ®çš„é¡ºåºã€‚æ¯ä¸€ä¸ªé€šé“éƒ½æ˜¯ä¸€ä¸ªå…·ä½“ç±»å‹çš„å¯¼ç®¡ï¼Œä¹Ÿå°±æ˜¯å£°æ˜channelçš„æ—¶å€™éœ€è¦ä¸ºå…¶æŒ‡å®šå…ƒç´ ç±»å‹ã€‚

channel ä¿—ç§°ç®¡é“ï¼Œç”¨äºæ•°æ®ä¼ é€’æˆ–æ•°æ®å…±äº«ï¼Œå…¶æœ¬è´¨æ˜¯ä¸€ä¸ªå…ˆè¿›å…ˆå‡ºçš„é˜Ÿåˆ—ï¼Œä½¿ç”¨ goroutine + channel è¿›è¡Œæ•°æ®é€šè®¯ç®€å•é«˜æ•ˆï¼ŒåŒæ—¶ä¹Ÿçº¿ç¨‹å®‰å…¨ï¼Œå¤šä¸ª goroutine å¯åŒæ—¶ä¿®æ”¹ä¸€ä¸ª channelï¼Œä¸éœ€è¦åŠ é”ã€‚

channel å¯åˆ†ä¸ºä¸‰ç§ç±»å‹ï¼š

- åªè¯» channelï¼šåªèƒ½è¯» channel é‡Œé¢æ•°æ®ï¼Œä¸å¯å†™å…¥

- åªå†™ channelï¼šåªèƒ½å†™æ•°æ®ï¼Œä¸å¯è¯»

- ä¸€èˆ¬ channelï¼šå¯è¯»å¯å†™

### 1ã€channelç±»å‹

`channel`æ˜¯ Go è¯­è¨€ä¸­ä¸€ç§ç‰¹æœ‰çš„ç±»å‹ã€‚å£°æ˜é€šé“ç±»å‹å˜é‡çš„æ ¼å¼å¦‚ä¸‹ï¼š

```go
var å˜é‡åç§° chan å…ƒç´ ç±»å‹
```

å…¶ä¸­ï¼š

- chanï¼šæ˜¯å…³é”®å­—
- å…ƒç´ ç±»å‹ï¼šæ˜¯æŒ‡é€šé“ä¸­ä¼ é€’å…ƒç´ çš„ç±»å‹

ä¸¾å‡ ä¸ªä¾‹å­ï¼š

```go
var ch1 chan int   // å£°æ˜ä¸€ä¸ªä¼ é€’æ•´å‹çš„é€šé“
var ch2 chan bool  // å£°æ˜ä¸€ä¸ªä¼ é€’å¸ƒå°”å‹çš„é€šé“
var ch3 chan []int // å£°æ˜ä¸€ä¸ªä¼ é€’intåˆ‡ç‰‡çš„é€šé“
```

### 2ã€channelé›¶å€¼

æœªåˆå§‹åŒ–çš„é€šé“ç±»å‹å˜é‡å…¶é»˜è®¤é›¶å€¼æ˜¯`nil`ã€‚

```go
var ch chan int
fmt.Println(ch) // <nil>
```

### 3ã€åˆå§‹åŒ–channel

å£°æ˜çš„é€šé“ç±»å‹å˜é‡éœ€è¦ä½¿ç”¨å†…ç½®çš„`make`å‡½æ•°åˆå§‹åŒ–ä¹‹åæ‰èƒ½ä½¿ç”¨ã€‚å…·ä½“æ ¼å¼å¦‚ä¸‹ï¼š

```go
make(chan å…ƒç´ ç±»å‹, [ç¼“å†²å¤§å°])
```

å…¶ä¸­ï¼š

- channelçš„ç¼“å†²å¤§å°æ˜¯å¯é€‰çš„ã€‚

ä¸¾å‡ ä¸ªä¾‹å­ï¼š

```go
ch4 := make(chan int)
ch5 := make(chan bool, 1)  // å£°æ˜ä¸€ä¸ªç¼“å†²åŒºå¤§å°ä¸º1çš„é€šé“
```

### 4ã€channelæ“ä½œ

é€šé“å…±æœ‰å‘é€ï¼ˆsendï¼‰ã€æ¥æ”¶(receiveï¼‰å’Œå…³é—­ï¼ˆcloseï¼‰ä¸‰ç§æ“ä½œã€‚è€Œå‘é€å’Œæ¥æ”¶æ“ä½œéƒ½ä½¿ç”¨`<-`ç¬¦å·ã€‚

ç°åœ¨æˆ‘ä»¬å…ˆä½¿ç”¨ä»¥ä¸‹è¯­å¥å®šä¹‰ä¸€ä¸ªé€šé“ï¼š

```go
ch := make(chan int)
```

#### 4.1 å‘é€

å°†ä¸€ä¸ªå€¼å‘é€åˆ°é€šé“ä¸­ã€‚

```go
ch <- 10 // æŠŠ10å‘é€åˆ°chä¸­
```

#### 4.2 æ¥æ”¶

ä»ä¸€ä¸ªé€šé“ä¸­æ¥æ”¶å€¼ã€‚

```go
x := <- ch // ä»chä¸­æ¥æ”¶å€¼å¹¶èµ‹å€¼ç»™å˜é‡x
<-ch       // ä»chä¸­æ¥æ”¶å€¼ï¼Œå¿½ç•¥ç»“æœ
```

#### 4.3 å…³é—­

æˆ‘ä»¬é€šè¿‡è°ƒç”¨å†…ç½®çš„`close`å‡½æ•°æ¥å…³é—­é€šé“ã€‚

```go
close(ch)
```

**æ³¨æ„ï¼š**ä¸€ä¸ªé€šé“å€¼æ˜¯å¯ä»¥è¢«åƒåœ¾å›æ”¶æ‰çš„ã€‚é€šé“é€šå¸¸ç”±å‘é€æ–¹æ‰§è¡Œå…³é—­æ“ä½œï¼Œå¹¶ä¸”åªæœ‰åœ¨æ¥æ”¶æ–¹æ˜ç¡®ç­‰å¾…é€šé“å…³é—­çš„ä¿¡å·æ—¶æ‰éœ€è¦æ‰§è¡Œå…³é—­æ“ä½œã€‚å®ƒå’Œå…³é—­æ–‡ä»¶ä¸ä¸€æ ·ï¼Œé€šå¸¸åœ¨ç»“æŸæ“ä½œä¹‹åå…³é—­æ–‡ä»¶æ˜¯å¿…é¡»è¦åšçš„ï¼Œä½†å…³é—­é€šé“ä¸æ˜¯å¿…é¡»çš„ã€‚

å…³é—­åçš„é€šé“æœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š

1. å¯¹ä¸€ä¸ªå…³é—­çš„é€šé“å†å‘é€å€¼å°±ä¼šå¯¼è‡´ panicã€‚
2. å¯¹ä¸€ä¸ªå…³é—­çš„é€šé“è¿›è¡Œæ¥æ”¶ä¼šä¸€ç›´è·å–å€¼ç›´åˆ°é€šé“ä¸ºç©ºã€‚
3. å¯¹ä¸€ä¸ªå…³é—­çš„å¹¶ä¸”æ²¡æœ‰å€¼çš„é€šé“æ‰§è¡Œæ¥æ”¶æ“ä½œä¼šå¾—åˆ°å¯¹åº”ç±»å‹çš„é›¶å€¼ã€‚
4. å…³é—­ä¸€ä¸ªå·²ç»å…³é—­çš„é€šé“ä¼šå¯¼è‡´ panicã€‚


## äºŒã€channel ä½¿ç”¨

å®šä¹‰å’Œå£°æ˜

```go
var readOnlyChan <-chan int            // åªè¯»chan
var writeOnlyChan chan<- int           // åªå†™chan
var mychan  chan int                     //è¯»å†™channel

//å®šä¹‰å®Œæˆä»¥åéœ€è¦makeæ¥åˆ†é…å†…å­˜ç©ºé—´ï¼Œä¸ç„¶ä½¿ç”¨ä¼šdeadlock
mychannel = make(chan int,10)

//æˆ–è€…
read_only := make (<-chan int,10)//å®šä¹‰åªè¯»çš„channel
write_only := make (chan<- int,10)//å®šä¹‰åªå†™çš„channel
read_write := make (chan int,10)//å¯åŒæ—¶è¯»å†™
```

### 1ã€è¯»å†™æ•°æ®

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

- ç®¡é“å¦‚æœæœªå…³é—­ï¼Œåœ¨è¯»å–è¶…æ—¶ä¼šåˆ™ä¼šå¼•å‘ deadlock å¼‚å¸¸
- ç®¡é“å¦‚æœå…³é—­è¿›è¡Œå†™å…¥æ•°æ®ä¼š pannic
- å½“ç®¡é“ä¸­æ²¡æœ‰æ•°æ®æ—¶å€™å†è¡Œè¯»å–æˆ–è¯»å–åˆ°é»˜è®¤å€¼ï¼Œå¦‚ int ç±»å‹é»˜è®¤å€¼æ˜¯ 0

```go
ch <- â€œwdâ€ // å†™æ•°æ®
a := <- ch // è¯»å–æ•°æ®
a, ok := <-ch // ä¼˜é›…çš„è¯»å–æ•°æ®
```

### 2ã€å¾ªç¯ç®¡é“

éœ€è¦æ³¨æ„çš„æ˜¯ï¼š

- ä½¿ç”¨ range å¾ªç¯ç®¡é“ï¼Œå¦‚æœç®¡é“æœªå…³é—­ä¼šå¼•å‘ deadlock é”™è¯¯ã€‚

- å¦‚æœé‡‡ç”¨ for æ­»å¾ªç¯å·²ç»å…³é—­çš„ç®¡é“ï¼Œå½“ç®¡é“æ²¡æœ‰æ•°æ®æ—¶å€™ï¼Œè¯»å–çš„æ•°æ®ä¼šæ˜¯ç®¡é“çš„é»˜è®¤å€¼ï¼Œå¹¶ä¸”å¾ªç¯ä¸ä¼šé€€å‡ºã€‚

```go
package main

import (
  "fmt"
  "time"
)

func main() {
  mychannel := make(chan int,10)
  for i := 0;i < 10;i++{
    mychannel <- i
  }
  close(mychannel)  //å…³é—­ç®¡é“
  fmt.Println("data lenght: ",len(mychannel))
  for  v := range mychannel {  //å¾ªç¯ç®¡é“
    fmt.Println(v)
  }
  fmt.Printf("data lenght:  %d",len(mychannel))
}
```

### 3ã€å¸¦ç¼“å†²åŒº channe å’Œä¸å¸¦ç¼“å†²åŒº channel

- å¸¦ç¼“å†²åŒº channelï¼šå®šä¹‰å£°æ˜æ—¶å€™åˆ¶å®šäº†ç¼“å†²åŒºå¤§å° (é•¿åº¦)ï¼Œå¯ä»¥ä¿å­˜å¤šä¸ªæ•°æ®ã€‚
- ä¸å¸¦ç¼“å†²åŒº channelï¼šåªèƒ½å­˜ä¸€ä¸ªæ•°æ®ï¼Œå¹¶ä¸”åªæœ‰å½“è¯¥æ•°æ®è¢«å–å‡ºæ—¶å€™æ‰èƒ½å­˜ä¸‹ä¸€ä¸ªæ•°æ®ã€‚


```go
ch := make(chan int) //ä¸å¸¦ç¼“å†²åŒº
ch := make(chan int ,10) //å¸¦ç¼“å†²åŒº
```

å¸¦ç¼“å†²åŒºç¤ºä¾‹ï¼š

```go
package main

import "fmt"

func f1(ch1 chan int) {
	for i := 1; i < 10; i++ {
		ch1 <- i
	}
	close(ch1)
}

func f2(ch1 chan int, ch2 chan int) {
	// ä»é€šé“ä¸­å–å€¼çš„æ–¹æ³•ä¸€
	for {
		temp, ok := <-ch1
		if !ok {
			break
		}
		ch2 <- temp * temp
	}
	close(ch2)
}

func main() {
	ch1 := make(chan int, 10)
	ch2 := make(chan int, 20)
	go f1(ch1)
	go f2(ch1, ch2)

	// ä»é€šé“ä¸­å–å€¼çš„æ–¹æ³•äºŒ
	for ret := range ch2 {
		fmt.Println(ret)
	}
}

/*
1
4
9
16
25
36
49
64
81
*/
```

ä¸å¸¦ç¼“å†²åŒºç¤ºä¾‹ï¼š

```go
package main

import "fmt"

func test(c chan int) {
  for i := 0; i < 10; i++ {
    fmt.Println("send ", i)
    c <- i
  }
}

func main() {
  ch := make(chan int)
  go test(ch)
  for j := 0; j < 10; j++ {
    fmt.Println("get ", <-ch)
  }
}
```

ç»“æœï¼š
```go
send  0
send  1
get  0
get  1
send  2
send  3
get  2
get  3
send  4
send  5
get  4
get  5
send  6
send  7
get  6
get  7
send  8
send  9
get  8
get  9
```

#### 3.1 æ— ç¼“å†²çš„é€šé“

æ— ç¼“å†²çš„é€šé“åˆç§°ä¸ºé˜»å¡çš„é€šé“ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å¦‚ä¸‹ä»£ç ç‰‡æ®µã€‚

```go
func main() {
	ch := make(chan int)
	ch <- 10
	fmt.Println("å‘é€æˆåŠŸ")
}
```

ä¸Šé¢è¿™æ®µä»£ç èƒ½å¤Ÿé€šè¿‡ç¼–è¯‘ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™ä¼šå‡ºç°ä»¥ä¸‹é”™è¯¯ï¼š

```bash
fatal error: all goroutines are asleep - deadlock!

goroutine 1 [chan send]:
main.main()
        .../main.go:8 +0x54
```

`deadlock`è¡¨ç¤ºæˆ‘ä»¬ç¨‹åºä¸­çš„ goroutine éƒ½è¢«æŒ‚èµ·å¯¼è‡´ç¨‹åºæ­»é”äº†ã€‚ä¸ºä»€ä¹ˆä¼šå‡ºç°`deadlock`é”™è¯¯å‘¢ï¼Ÿ

å› ä¸ºæˆ‘ä»¬ä½¿ç”¨`ch := make(chan int)`åˆ›å»ºçš„æ˜¯æ— ç¼“å†²çš„é€šé“ï¼Œæ— ç¼“å†²çš„é€šé“åªæœ‰åœ¨æœ‰æ¥æ”¶æ–¹èƒ½å¤Ÿæ¥æ”¶å€¼çš„æ—¶å€™æ‰èƒ½å‘é€æˆåŠŸï¼Œå¦åˆ™ä¼šä¸€ç›´å¤„äºç­‰å¾…å‘é€çš„é˜¶æ®µã€‚åŒç†ï¼Œå¦‚æœå¯¹ä¸€ä¸ªæ— ç¼“å†²é€šé“æ‰§è¡Œæ¥æ”¶æ“ä½œæ—¶ï¼Œæ²¡æœ‰ä»»ä½•å‘é€šé“ä¸­å‘é€å€¼çš„æ“ä½œé‚£ä¹ˆä¹Ÿä¼šå¯¼è‡´æ¥æ”¶æ“ä½œé˜»å¡ã€‚å°±åƒç”°å¾„æ¯”èµ›ä¸­çš„4x100æ¥åŠ›èµ›ï¼Œæƒ³è¦å®Œæˆäº¤æ£’å¿…é¡»æœ‰ä¸€ä¸ªèƒ½å¤Ÿæ¥æ£’çš„è¿åŠ¨å‘˜ï¼Œå¦åˆ™åªèƒ½ç­‰å¾…ã€‚ç®€å•æ¥è¯´å°±æ˜¯æ— ç¼“å†²çš„é€šé“å¿…é¡»æœ‰è‡³å°‘ä¸€ä¸ªæ¥æ”¶æ–¹æ‰èƒ½å‘é€æˆåŠŸã€‚

ä¸Šé¢çš„ä»£ç ä¼šé˜»å¡åœ¨`ch <- 10`è¿™ä¸€è¡Œä»£ç å½¢æˆæ­»é”ï¼Œé‚£å¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿ

å…¶ä¸­ä¸€ç§å¯è¡Œçš„æ–¹æ³•æ˜¯åˆ›å»ºä¸€ä¸ª goroutine å»æ¥æ”¶å€¼ï¼Œä¾‹å¦‚ï¼š

```go
func recv(c chan int) {
	ret := <-c
	fmt.Println("æ¥æ”¶æˆåŠŸ", ret)
}

func main() {
	ch := make(chan int)
	go recv(ch) // åˆ›å»ºä¸€ä¸ª goroutine ä»é€šé“æ¥æ”¶å€¼
	ch <- 10
	fmt.Println("å‘é€æˆåŠŸ")
}
```

é¦–å…ˆæ— ç¼“å†²é€šé“`ch`ä¸Šçš„å‘é€æ“ä½œä¼šé˜»å¡ï¼Œç›´åˆ°å¦ä¸€ä¸ª goroutine åœ¨è¯¥é€šé“ä¸Šæ‰§è¡Œæ¥æ”¶æ“ä½œï¼Œè¿™æ—¶æ•°å­—10æ‰èƒ½å‘é€æˆåŠŸï¼Œä¸¤ä¸ª goroutine å°†ç»§ç»­æ‰§è¡Œã€‚ç›¸åï¼Œå¦‚æœæ¥æ”¶æ“ä½œå…ˆæ‰§è¡Œï¼Œæ¥æ”¶æ–¹æ‰€åœ¨çš„ goroutine å°†é˜»å¡ï¼Œç›´åˆ° main goroutine ä¸­å‘è¯¥é€šé“å‘é€æ•°å­—10ã€‚

ä½¿ç”¨æ— ç¼“å†²é€šé“è¿›è¡Œé€šä¿¡å°†å¯¼è‡´å‘é€å’Œæ¥æ”¶çš„ goroutine åŒæ­¥åŒ–ã€‚å› æ­¤ï¼Œæ— ç¼“å†²é€šé“ä¹Ÿè¢«ç§°ä¸º`åŒæ­¥é€šé“`ã€‚

#### 3.2 æœ‰ç¼“å†²çš„é€šé“

è¿˜æœ‰å¦å¤–ä¸€ç§è§£å†³ä¸Šé¢æ­»é”é—®é¢˜çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯ä½¿ç”¨æœ‰ç¼“å†²åŒºçš„é€šé“ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä½¿ç”¨ make å‡½æ•°åˆå§‹åŒ–é€šé“æ—¶ï¼Œå¯ä»¥ä¸ºå…¶æŒ‡å®šé€šé“çš„å®¹é‡ï¼Œä¾‹å¦‚ï¼š

```go
func main() {
	ch := make(chan int, 1) // åˆ›å»ºä¸€ä¸ªå®¹é‡ä¸º1çš„æœ‰ç¼“å†²åŒºé€šé“
	ch <- 10
	fmt.Println("å‘é€æˆåŠŸ")
}
```

åªè¦é€šé“çš„å®¹é‡å¤§äºé›¶ï¼Œé‚£ä¹ˆè¯¥é€šé“å°±å±äºæœ‰ç¼“å†²çš„é€šé“ï¼Œé€šé“çš„å®¹é‡è¡¨ç¤ºé€šé“ä¸­æœ€å¤§èƒ½å­˜æ”¾çš„å…ƒç´ æ•°é‡ã€‚å½“é€šé“å†…å·²æœ‰å…ƒç´ æ•°è¾¾åˆ°æœ€å¤§å®¹é‡åï¼Œå†å‘é€šé“æ‰§è¡Œå‘é€æ“ä½œå°±ä¼šé˜»å¡ï¼Œé™¤éæœ‰ä»é€šé“æ‰§è¡Œæ¥æ”¶æ“ä½œã€‚å°±åƒä½ å°åŒºçš„å¿«é€’æŸœåªæœ‰é‚£ä¹ˆä¸ªå¤šæ ¼å­ï¼Œæ ¼å­æ»¡äº†å°±è£…ä¸ä¸‹äº†ï¼Œå°±é˜»å¡äº†ï¼Œç­‰åˆ°åˆ«äººå–èµ°ä¸€ä¸ªå¿«é€’å‘˜å°±èƒ½å¾€é‡Œé¢æ”¾ä¸€ä¸ªã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨å†…ç½®çš„`len`å‡½æ•°è·å–é€šé“å†…å…ƒç´ çš„æ•°é‡ï¼Œä½¿ç”¨`cap`å‡½æ•°è·å–é€šé“çš„å®¹é‡ï¼Œè™½ç„¶æˆ‘ä»¬å¾ˆå°‘ä¼šè¿™ä¹ˆåšã€‚

### 4ã€channel å®ç°ä½œä¸šæ± 

æˆ‘ä»¬åˆ›å»ºä¸‰ä¸ª channelï¼Œä¸€ä¸ª channel ç”¨äºæ¥å—ä»»åŠ¡ï¼Œä¸€ä¸ª channel ç”¨äºä¿æŒç»“æœï¼Œè¿˜æœ‰ä¸ª channel ç”¨äºå†³å®šç¨‹åºé€€å‡ºçš„æ—¶å€™ã€‚


```go

package main

import (
  "fmt"
)

func Task(taskch, resch chan int, exitch chan bool) {
  defer func() {   //å¼‚å¸¸å¤„ç†
    err := recover()
    if err != nil {
      fmt.Println("do task errorï¼š", err)
      return
    }
  }()
  
  for t := range taskch { //  å¤„ç†ä»»åŠ¡
    fmt.Println("do task :", t)
    resch <- t //
  }
  exitch <- true //å¤„ç†å®Œå‘é€é€€å‡ºä¿¡å·
}

func main() {
  taskch := make(chan int, 20) //ä»»åŠ¡ç®¡é“
  resch := make(chan int, 20)  //ç»“æœç®¡é“
  exitch := make(chan bool, 5) //é€€å‡ºç®¡é“
  go func() {
    for i := 0; i < 10; i++ {
      taskch <- i
    }
    close(taskch)
  }()
  
  for i := 0; i < 5; i++ {  //å¯åŠ¨5ä¸ªgoroutineåšä»»åŠ¡
    go Task(taskch, resch, exitch)
  }

  go func() { //ç­‰5ä¸ªgoroutineç»“æŸ
    for i := 0; i < 5; i++ {
      <-exitch
    }
    close(resch)  //ä»»åŠ¡å¤„ç†å®Œæˆå…³é—­ç»“æœç®¡é“ï¼Œä¸ç„¶rangeæŠ¥é”™
    close(exitch)  //å…³é—­é€€å‡ºç®¡é“
  }()

  for res := range resch{  //æ‰“å°ç»“æœ
    fmt.Println("task resï¼š",res)
  }
}
```
#### 4.1 å¤šè¿”å›å€¼æ¨¡å¼

å½“å‘é€šé“ä¸­å‘é€å®Œæ•°æ®æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`close`å‡½æ•°æ¥å…³é—­é€šé“ã€‚å½“ä¸€ä¸ªé€šé“è¢«å…³é—­åï¼Œå†å¾€è¯¥é€šé“å‘é€å€¼ä¼šå¼•å‘`panic`ï¼Œä»è¯¥é€šé“å–å€¼çš„æ“ä½œä¼šå…ˆå–å®Œé€šé“ä¸­çš„å€¼ã€‚é€šé“å†…çš„å€¼è¢«æ¥æ”¶å®Œåå†å¯¹é€šé“æ‰§è¡Œæ¥æ”¶æ“ä½œå¾—åˆ°çš„å€¼ä¼šä¸€ç›´éƒ½æ˜¯å¯¹åº”å…ƒç´ ç±»å‹çš„é›¶å€¼ã€‚é‚£æˆ‘ä»¬å¦‚ä½•åˆ¤æ–­ä¸€ä¸ªé€šé“æ˜¯å¦è¢«å…³é—­äº†å‘¢ï¼Ÿ

å¯¹ä¸€ä¸ªé€šé“æ‰§è¡Œæ¥æ”¶æ“ä½œæ—¶æ”¯æŒä½¿ç”¨å¦‚ä¸‹å¤šè¿”å›å€¼æ¨¡å¼ã€‚

```go
value, ok := <- ch
```

å…¶ä¸­ï¼š

- valueï¼šä»é€šé“ä¸­å–å‡ºçš„å€¼ï¼Œå¦‚æœé€šé“è¢«å…³é—­åˆ™è¿”å›å¯¹åº”ç±»å‹çš„é›¶å€¼ã€‚
- okï¼šé€šé“chå…³é—­æ—¶è¿”å› falseï¼Œå¦åˆ™è¿”å› trueã€‚

ä¸‹é¢ä»£ç ç‰‡æ®µä¸­çš„`f2`å‡½æ•°ä¼šå¾ªç¯ä»é€šé“`ch`ä¸­æ¥æ”¶æ‰€æœ‰å€¼ï¼Œç›´åˆ°é€šé“è¢«å…³é—­åé€€å‡ºã€‚

```go
func f2(ch chan int) {
	for {
		v, ok := <-ch
		if !ok {
			fmt.Println("é€šé“å·²å…³é—­")
			break
		}
		fmt.Printf("v:%#v ok:%#v\n", v, ok)
	}
}

func main() {
	ch := make(chan int, 2)
	ch <- 1
	ch <- 2
	close(ch)
	f2(ch)
}
```

#### 4.2 for rangeæ¥æ”¶å€¼

é€šå¸¸æˆ‘ä»¬ä¼šé€‰æ‹©ä½¿ç”¨`for range`å¾ªç¯ä»é€šé“ä¸­æ¥æ”¶å€¼ï¼Œå½“é€šé“è¢«å…³é—­åï¼Œä¼šåœ¨é€šé“å†…çš„æ‰€æœ‰å€¼è¢«æ¥æ”¶å®Œæ¯•åä¼šè‡ªåŠ¨é€€å‡ºå¾ªç¯ã€‚ä¸Šé¢é‚£ä¸ªç¤ºä¾‹æˆ‘ä»¬ä½¿ç”¨`for range`æ”¹å†™åä¼šå¾ˆç®€æ´ã€‚

```go
func f3(ch chan int) {
	for v := range ch {
		fmt.Println(v)
	}
}
```

**æ³¨æ„ï¼š**ç›®å‰Goè¯­è¨€ä¸­å¹¶æ²¡æœ‰æä¾›ä¸€ä¸ªä¸å¯¹é€šé“è¿›è¡Œè¯»å–æ“ä½œå°±èƒ½åˆ¤æ–­é€šé“æ˜¯å¦è¢«å…³é—­çš„æ–¹æ³•ã€‚ä¸èƒ½ç®€å•çš„é€šè¿‡`len(ch)`æ“ä½œæ¥åˆ¤æ–­é€šé“æ˜¯å¦è¢«å…³é—­ã€‚

### 5ã€åªè¯» channel å’Œåªå†™ channel

ä¸€èˆ¬å®šä¹‰åªè¯»å’Œåªå†™çš„ç®¡é“æ„ä¹‰ä¸å¤§ï¼Œæ›´å¤šæ—¶å€™æˆ‘ä»¬å¯ä»¥åœ¨å‚æ•°ä¼ é€’æ—¶å€™æŒ‡æ˜ç®¡é“å¯è¯»è¿˜æ˜¯å¯å†™ï¼Œå³ä½¿å½“å‰ç®¡é“æ˜¯å¯è¯»å†™çš„ã€‚

```go
package main

import (
  "fmt"
  "time"
)

//åªèƒ½å‘chané‡Œå†™æ•°æ®
func send(c chan<- int) {
  for i := 0; i < 10; i++ {
    c <- i
  }
}

//åªèƒ½å–channelä¸­çš„æ•°æ®
func get(c <-chan int) {
  for i := range c {
    fmt.Println(i)
  }
}

func main() {
  c := make(chan int)
  go send(c)
  go get(c)
  time.Sleep(time.Second*1)
}
```

ç»“æœï¼š

```go
0
1
2
3
4
5
6
7
8
9
```

#### å•å‘é€šé“

åœ¨æŸäº›åœºæ™¯ä¸‹æˆ‘ä»¬å¯èƒ½ä¼šå°†é€šé“ä½œä¸ºå‚æ•°åœ¨å¤šä¸ªä»»åŠ¡å‡½æ•°é—´è¿›è¡Œä¼ é€’ï¼Œé€šå¸¸æˆ‘ä»¬ä¼šé€‰æ‹©åœ¨ä¸åŒçš„ä»»åŠ¡å‡½æ•°ä¸­å¯¹é€šé“çš„ä½¿ç”¨è¿›è¡Œé™åˆ¶ï¼Œæ¯”å¦‚é™åˆ¶é€šé“åœ¨æŸä¸ªå‡½æ•°ä¸­åªèƒ½æ‰§è¡Œå‘é€æˆ–åªèƒ½æ‰§è¡Œæ¥æ”¶æ“ä½œã€‚æƒ³è±¡ä¸€ä¸‹ï¼Œæˆ‘ä»¬ç°åœ¨æœ‰`Producer`å’Œ`Consumer`ä¸¤ä¸ªå‡½æ•°ï¼Œå…¶ä¸­`Producer`å‡½æ•°ä¼šè¿”å›ä¸€ä¸ªé€šé“ï¼Œå¹¶ä¸”ä¼šæŒç»­å°†ç¬¦åˆæ¡ä»¶çš„æ•°æ®å‘é€è‡³è¯¥é€šé“ï¼Œå¹¶åœ¨å‘é€å®Œæˆåå°†è¯¥é€šé“å…³é—­ã€‚è€Œ`Consumer`å‡½æ•°çš„ä»»åŠ¡æ˜¯ä»é€šé“ä¸­æ¥æ”¶å€¼è¿›è¡Œè®¡ç®—ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°ä¹‹é—´é€šè¿‡`Processer`å‡½æ•°è¿”å›çš„é€šé“è¿›è¡Œé€šä¿¡ã€‚å®Œæ•´çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ã€‚

```go
package main

import (
	"fmt"
)

// Producer è¿”å›ä¸€ä¸ªé€šé“
// å¹¶æŒç»­å°†ç¬¦åˆæ¡ä»¶çš„æ•°æ®å‘é€è‡³è¿”å›çš„é€šé“ä¸­
// æ•°æ®å‘é€å®Œæˆåä¼šå°†è¿”å›çš„é€šé“å…³é—­
func Producer() chan int {
	ch := make(chan int, 2)
	// åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineæ‰§è¡Œå‘é€æ•°æ®çš„ä»»åŠ¡
	go func() {
		for i := 0; i < 10; i++ {
			if i%2 == 1 {
				ch <- i
			}
		}
		close(ch) // ä»»åŠ¡å®Œæˆåå…³é—­é€šé“
	}()

	return ch
}

// Consumer ä»é€šé“ä¸­æ¥æ”¶æ•°æ®è¿›è¡Œè®¡ç®—
func Consumer(ch chan int) int {
	sum := 0
	for v := range ch {
		sum += v
	}
	return sum
}

func main() {
	ch := Producer()

	res := Consumer(ch)
	fmt.Println(res) // 25

}
```

ä»ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ä¸­å¯ä»¥çœ‹å‡ºæ­£å¸¸æƒ…å†µä¸‹`Consumer`å‡½æ•°ä¸­åªä¼šå¯¹é€šé“è¿›è¡Œæ¥æ”¶æ“ä½œï¼Œä½†æ˜¯è¿™ä¸ä»£è¡¨ä¸å¯ä»¥åœ¨`Consumer`å‡½æ•°ä¸­å¯¹é€šé“è¿›è¡Œå‘é€æ“ä½œã€‚ä½œä¸º`Producer`å‡½æ•°çš„æä¾›è€…ï¼Œæˆ‘ä»¬åœ¨è¿”å›é€šé“çš„æ—¶å€™å¯èƒ½åªå¸Œæœ›è°ƒç”¨æ–¹æ‹¿åˆ°è¿”å›çš„é€šé“ååªèƒ½å¯¹å…¶è¿›è¡Œæ¥æ”¶æ“ä½œã€‚ä½†æ˜¯æˆ‘ä»¬æ²¡æœ‰åŠæ³•é˜»æ­¢åœ¨`Consumer`å‡½æ•°ä¸­å¯¹é€šé“è¿›è¡Œå‘é€æ“ä½œã€‚

Goè¯­è¨€ä¸­æä¾›äº†**å•å‘é€šé“**æ¥å¤„ç†è¿™ç§éœ€è¦é™åˆ¶é€šé“åªèƒ½è¿›è¡ŒæŸç§æ“ä½œçš„æƒ…å†µã€‚

```go
<- chan int // åªæ¥æ”¶é€šé“ï¼Œåªèƒ½æ¥æ”¶ä¸èƒ½å‘é€
chan <- int // åªå‘é€é€šé“ï¼Œåªèƒ½å‘é€ä¸èƒ½æ¥æ”¶
```

å…¶ä¸­ï¼Œç®­å¤´`<-`å’Œå…³é”®å­—`chan`çš„ç›¸å¯¹ä½ç½®è¡¨æ˜äº†å½“å‰é€šé“å…è®¸çš„æ“ä½œï¼Œè¿™ç§é™åˆ¶å°†åœ¨ç¼–è¯‘é˜¶æ®µè¿›è¡Œæ£€æµ‹ã€‚å¦å¤–å¯¹ä¸€ä¸ªåªæ¥æ”¶é€šé“æ‰§è¡Œcloseä¹Ÿæ˜¯ä¸å…è®¸çš„ï¼Œå› ä¸ºé»˜è®¤é€šé“çš„å…³é—­æ“ä½œåº”è¯¥ç”±å‘é€æ–¹æ¥å®Œæˆã€‚

æˆ‘ä»¬ä½¿ç”¨å•å‘é€šé“å°†ä¸Šé¢çš„ç¤ºä¾‹ä»£ç è¿›è¡Œå¦‚ä¸‹æ”¹é€ ã€‚

```go
// Producer2 è¿”å›ä¸€ä¸ªæ¥æ”¶é€šé“
func Producer2() <-chan int {
	ch := make(chan int, 2)
	// åˆ›å»ºä¸€ä¸ªæ–°çš„goroutineæ‰§è¡Œå‘é€æ•°æ®çš„ä»»åŠ¡
	go func() {
		for i := 0; i < 10; i++ {
			if i%2 == 1 {
				ch <- i
			}
		}
		close(ch) // ä»»åŠ¡å®Œæˆåå…³é—­é€šé“
	}()

	return ch
}

// Consumer2 å‚æ•°ä¸ºæ¥æ”¶é€šé“
func Consumer2(ch <-chan int) int {
	sum := 0
	for v := range ch {
		sum += v
	}
	return sum
}

func main() {
	ch2 := Producer2()
  
	res2 := Consumer2(ch2)
	fmt.Println(res2) // 25
}
```

è¿™ä¸€æ¬¡ï¼Œ`Producer`å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªåªæ¥æ”¶é€šé“ï¼Œè¿™å°±ä»ä»£ç å±‚é¢é™åˆ¶äº†è¯¥å‡½æ•°è¿”å›çš„é€šé“åªèƒ½è¿›è¡Œæ¥æ”¶æ“ä½œï¼Œä¿è¯äº†æ•°æ®å®‰å…¨ã€‚å¾ˆå¤šè¯»è€…çœ‹åˆ°è¿™ä¸ªç¤ºä¾‹å¯èƒ½ä¼šè§‰ç€è¿™æ ·çš„é™åˆ¶æ˜¯å¤šä½™çš„ï¼Œä½†æ˜¯è¯•æƒ³ä¸€ä¸‹å¦‚æœ`Producer`å‡½æ•°å¯ä»¥åœ¨å…¶ä»–åœ°æ–¹è¢«å…¶ä»–äººè°ƒç”¨ï¼Œä½ è¯¥å¦‚ä½•é™åˆ¶ä»–äººä¸å¯¹è¯¥é€šé“æ‰§è¡Œå‘é€æ“ä½œå‘¢ï¼Ÿå¹¶ä¸”è¿”å›é™åˆ¶æ“ä½œçš„å•å‘é€šé“ä¹Ÿä¼šè®©ä»£ç è¯­ä¹‰æ›´æ¸…æ™°ã€æ›´æ˜“è¯»ã€‚

åœ¨å‡½æ•°ä¼ å‚åŠä»»ä½•èµ‹å€¼æ“ä½œä¸­å…¨å‘é€šé“ï¼ˆæ­£å¸¸é€šé“ï¼‰å¯ä»¥è½¬æ¢ä¸ºå•å‘é€šé“ï¼Œä½†æ˜¯æ— æ³•åå‘è½¬æ¢ã€‚

```go
var ch3 = make(chan int, 1)
ch3 <- 10
close(ch3)
Consumer2(ch3) // å‡½æ•°ä¼ å‚æ—¶å°†ch3è½¬ä¸ºå•å‘é€šé“

var ch4 = make(chan int, 1)
ch4 <- 10
var ch5 <-chan int // å£°æ˜ä¸€ä¸ªåªæ¥æ”¶é€šé“ch5
ch5 = ch4          // å˜é‡èµ‹å€¼æ—¶å°†ch4è½¬ä¸ºå•å‘é€šé“
<-ch5
```

### 6ã€select-case å®ç°éé˜»å¡ channel

åŸç†é€šè¿‡ select+case åŠ å…¥ä¸€ç»„ç®¡é“ï¼Œå½“æ»¡è¶³ï¼ˆè¿™é‡Œè¯´çš„æ»¡è¶³æ„æ€æ˜¯æœ‰æ•°æ®å¯è¯»æˆ–è€…å¯å†™) select ä¸­çš„æŸä¸ª case æ—¶å€™ï¼Œé‚£ä¹ˆè¯¥ case è¿”å›ï¼Œè‹¥éƒ½ä¸æ»¡è¶³ caseï¼Œåˆ™èµ° default åˆ†æ”¯ã€‚

```go
package main

import (
  "fmt"
)

func send(c chan int)  {
  for i :=1 ; i<10 ;i++  {
    c <-i
    fmt.Println("send data : ",i)
  }
}

func main() {
  resch := make(chan int,20)
  strch := make(chan string,10)
  go send(resch)
  strch <- "wd"
  select {
    case a := <-resch:
    fmt.Println("get data : ", a)
    case b := <-strch:
    fmt.Println("get data : ", b)
    default:
    fmt.Println("no channel actvie")
  }
}
```

ç»“æœï¼š

```go
get data :  wd
```

### 7ã€channel é¢‘ç‡æ§åˆ¶

åœ¨å¯¹ channel è¿›è¡Œè¯»å†™çš„æ—¶ï¼Œgo è¿˜æä¾›äº†éå¸¸äººæ€§åŒ–çš„æ“ä½œï¼Œé‚£å°±æ˜¯å¯¹è¯»å†™çš„é¢‘ç‡æ§åˆ¶ï¼Œé€šè¿‡ time.Ticke å®ç°

ç¤ºä¾‹ï¼š

```go
package main

import (
  "time"
  "fmt"
)

func main(){
  requests:= make(chan int ,5)
  for i:=1;i<5;i++{
    requests<-i
  }
  
  close(requests)
  limiter := time.Tick(time.Second*1)
  
  for req:=range requests{
    <-limiter
    fmt.Println("requets",req,time.Now()) //æ‰§è¡Œåˆ°è¿™é‡Œï¼Œéœ€è¦éš”1ç§’æ‰ç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼Œtime.Tick(timer)ä¸Šé¢å·²å®šä¹‰
  }
}
```

ç»“æœï¼š

```go
requets 1 2018-07-06 10:17:35.98056403 +0800 CST m=+1.004248763
requets 2 2018-07-06 10:17:36.978123472 +0800 CST m=+2.001798205
requets 3 2018-07-06 10:17:37.980869517 +0800 CST m=+3.004544250
requets 4 2018-07-06 10:17:38.976868836 +0800 CST m=+4.000533569
```

### 8ã€æ€»ç»“

ä¸‹é¢çš„è¡¨æ ¼ä¸­æ€»ç»“äº†å¯¹ä¸åŒçŠ¶æ€ä¸‹çš„é€šé“æ‰§è¡Œç›¸åº”æ“ä½œçš„ç»“æœã€‚

![img](https://ian-kevin.oss-cn-beijing.aliyuncs.com/img/channel.png)

**æ³¨æ„ï¼š**å¯¹å·²ç»å…³é—­çš„é€šé“å†æ‰§è¡Œ close ä¹Ÿä¼šå¼•å‘ panicã€‚

## ä¸‰ã€channel ä¸åç¨‹é—´é€šä¿¡

go ä¸­æœ‰ä¸€ç§æ•°æ®ç±»å‹ chanï¼Œå®ƒæœ¬èº«çš„ç”¨é€”æ˜¯æ¶ˆæ¯é€šé“ï¼Œç”¨æ¥åœ¨ goroutines é—´å®ç°æ¥æ”¶ã€å‘é€æ¶ˆæ¯ã€‚åŒæ—¶æœ‰ç¼“å­˜åŠŸèƒ½ï¼Œå› æ­¤å¯è§†å®ƒä¸ºè·¨åç¨‹é˜Ÿåˆ—ã€‚ 

> æ³¨æ„ï¼Œæ˜¯è¯­è¨€çº§åˆ«ä¸Šçš„æ”¯æŒï¼Œä¸åŒå‡½æ•°åº“æ”¯æŒã€‚è¿™ä¸€ç‚¹å¯ä»¥è®©å®ƒçš„è¡¨è¾¾è¯­æ³•è®¾è®¡å¾—æ›´ç®€å•ã€‚ è¿™ä¸ªè·¨åç¨‹æ¶ˆæ¯é€šä¿¡åŠŸèƒ½ï¼Œå¯ä»¥éå¸¸ç®€å•åœ°å®ç°å…¶å®ƒè¯­è¨€ä¸­è¾ƒéº»çƒ¦çš„å¹¶å‘ä»»åŠ¡ç³»ç»Ÿã€å·¥ä½œé˜Ÿåˆ—ç³»ç»Ÿã€‚

*channel* æ˜¯ä¸€ä¸ªé€šé“ã€é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæˆ‘ä»¬å…³å¿ƒçš„åº”è¯¥å°±æ˜¯å¦‚ä½•åˆ›å»ºè¿™ä¸ªé€šé“ã€å°†æ•°æ®è£…åˆ°é€šé“ä¸­ã€ä»é€šé“ä¸­æå–æ•°æ®ã€‚ golang ä¸ºå®ƒè®¾è®¡äº†ä¸€ä¸ªæ“ä½œç¬¦ï¼Œ`left <- right`ï¼Œå½“ `left` ä¸º channel æ—¶ï¼Œè¡¨ç¤ºå‘é€šé“ä¸­å†™å…¥æ•°æ®ï¼ˆå‘é€ï¼‰ï¼Œå½“ `right` ä¸ºé€šé“æ—¶ï¼Œè¡¨ç¤ºä»é€šé“æå–æ•°æ®ï¼ˆæ¥æ”¶ï¼‰ã€‚

```go
package main

import  "fmt"

func main() {
  // fmt.Println("ğŸ˜€ğŸ˜€ æœ‰æ‚Ÿçš„ go channel ç¤ºä¾‹ ğŸ˜€ğŸ˜€")
  simpleChan()
}

func simpleChan() {
  // å£°æ˜ä¸€ chan ç±»å‹çš„å˜é‡
  var ch chan string
  ch = make(chan string)
  // å‘ channel ä¸­å‘é€ string ç±»å‹æ•°æ®
  go func() {
    ch <- "ping"
  }()
  // åˆ›å»ºä¸€ä¸ª string ç±»å‹çš„å˜é‡ï¼Œç”¨æ¥ä¿å­˜ä» channel é˜Ÿåˆ—æå–çš„æ•°æ®
  var v string
  v = <-ch
  fmt.Println(v) // ping
}
```

æ ¹æ® go å˜é‡å£°æ˜çš„è¯­æ³•ï¼Œä¸Šé¢å¯ä»¥ç®€å†™ä¸ºï¼š

```go
// channel.go
...
    ch := make(chan string)
    go func() {
     ch <- "ping"
    }()
    v := <-ch
    fmt.Println(v)
...
```

ä¸¤ä¸ªæ“ä½œè¯­å¥å°±å¯ä»¥å®Œæˆäº†æ•°æ®å…¥é˜Ÿåˆ—ï¼ˆ`ch <- "ping"`ï¼‰ï¼Œæ•°æ®å‡ºé˜Ÿåˆ—(`v = <-ch`)çš„åŠ¨ä½œã€‚è¿™é‡Œæœ‰ä¸ªé—®é¢˜éœ€è¦æ³¨æ„ï¼Œ*channel çš„æ¥æ”¶ä¸å‘é€éœ€è¦åˆ†åˆ«åœ¨ä¸¤ä¸ª goroutine* ä¸­ï¼Œå¦‚æœä½ æ˜¯ç›´æ¥çœ‹è‹±æ–‡çš„æ–‡æ¡£ã€æˆ–è€…å…¶ä»–ä»‹ç»çš„æ–‡ç« ï¼Œå¯èƒ½æ²¡æœ‰æŒ‡å‡ºè¿™ä¸ªè¦æ±‚ã€‚å®ƒæ˜¯ *è·¨* åç¨‹çš„ã€‚

```go
â”Œâ”€â”                                â”Œâ”€â”
â”‚gâ”‚                                â”‚gâ”‚
â”‚oâ”‚                                â”‚oâ”‚
â”‚râ”‚                                â”‚râ”‚
â”‚oâ”‚                                â”‚oâ”‚
â”‚uâ”‚                                â”‚uâ”‚
â”‚tâ”‚                                â”‚tâ”‚
â”‚iâ”‚ receive/             send/     â”‚iâ”‚
â”‚nâ”‚ queue outâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” queue in  â”‚nâ”‚
â”‚eâ”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ channel â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚eâ”‚
â”‚1â”‚          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚2â”‚
â””â”€â”˜                                â””â”€â”˜
```

è‹¥å‘é€ä¸æ¥æ”¶æ²¡æœ‰åˆ†å¸ƒåœ¨ä¸¤ä¸ª goroutine ä¸­ï¼Œä¼šå‡ºç°è¿™æ ·çš„æŠ¥é”™ä¿¡æ¯ï¼š

```go
// channel.go
ch := make(chan string)
ch <- "ping"
v := <-ch

// æŠ¥é”™
âœ  go build channel.go && ./channel
fatal error: all goroutines are asleep - deadlock!
```

ç”¨ä¸€å¥è¯æ€»ç»“ï¼šchannel æ˜¯è¿æ¥ concurrent goroutines çš„ç®¡é“ï¼ˆpipeï¼‰ã€‚

### åœºæ™¯ç¤ºä¾‹

**ç®€å•çš„ worker pool ç¼–ç¨‹æ¨¡å‹**

ç”¨ channel çš„è·¨åç¨‹æ¶ˆæ¯é€šè®¯ï¼ˆæ•°æ®ä¼ è¾“ï¼‰åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ä¸€ä¸ª worker poolã€‚

- ä¸€ä¸ª jobs é˜Ÿåˆ—ï¼Œç¼“å­˜éœ€è¦å¤„ç†çš„ jobs
- å‡ ä¸ª worker å·¥ä½œåç¨‹ï¼Œä» jobs é˜Ÿåˆ—å–ä»»åŠ¡æ¥å¤„ç†
- ä¸€ä¸ª results é˜Ÿåˆ—ï¼Œä¿å­˜ä»»åŠ¡å¤„ç†ç»“æœ

```go
// channel.go
package main

import (
  "fmt"
  "time"
)

func main() {
  workpools()
}

func workpools() {
  const number_of_jobs = 5
  const number_of_workers = 2
  jobs := make(chan int, number_of_jobs)
  results := make(chan string, number_of_jobs)

  // æ§åˆ¶å¹¶è¡Œåº¦ï¼Œæ¯ä¸ª worker å‡½æ•°éƒ½è¿è¡Œåœ¨å•ç‹¬çš„ goroutine ä¸­
  for w := 1; w <= number_of_workers; w++ {
    go worker(w, jobs, results)
  }

  // å‘ ä»»åŠ¡é˜Ÿåˆ—å†™å…¥ä»»åŠ¡
  for i := 1; i <= number_of_jobs; i++ {
    jobs <- i
  }
  fmt.Println("å¸ƒç½® job åï¼Œå…³é—­ jobs channel")
  close(jobs)

  // ç›‘å¬ results channelï¼Œåªè¦æœ‰å†…å®¹å°±ä¼šè¢«å–èµ°
  for i := 1; i <= number_of_jobs; i++ {
    fmt.Printf("ç»“æœ: %s\n", <-results)
  }
}

// worker é€»è¾‘ï¼šä¸€ä¸ªä¸æ–­ä» jobs chan ä¸­å–ä»»åŠ¡çš„å¾ªç¯
// å¹¶å°†ç»“æœæ”¾åœ¨ out channel ä¸­å¾…å–
func worker(id int, jobs <-chan int, out chan<- string) {
  fmt.Printf("worker #%d å¯åŠ¨\n", id)
  for job := range jobs {
    fmt.Printf("worker #%d å¼€å§‹ å·¥ä½œ%d\n", id, job)
    // sleep æ¨¡æ‹Ÿ ã€æ­£åœ¨å¤„ç†ä»»åŠ¡ã€
    time.Sleep(time.Millisecond * 500)
    fmt.Printf("worker #%d ç»“æŸ å·¥ä½œ%d\n", id, job)

    out <- fmt.Sprintf("worker #%d å·¥ä½œ%d", id, job)
  }
  fmt.Printf("worker #%d é€€å‡º\n", id)
}
```

> æœ¬ä¾‹ä»…ç”¨äºè®²è§£æ¼”ç¤ºï¼Œè¯·å‹¿åœ¨ç”Ÿäº§ç³»ç»Ÿçš„ç¨‹åºä¸­ç…§æ¬ã€‚

ä¸Šé¢è¿‡ç¨‹ï¼Œä½¿ç”¨äº† `go func(){}()`ï¼ˆç”Ÿæˆ goåç¨‹ï¼‰ã€`chan`ï¼ˆä¼ é€’æ•°æ®çš„ç®¡é“ï¼‰ ç®€å•åœ°å®ç°äº†ä¸€ä¸ªå…·æœ‰å¹¶å‘åŠŸèƒ½çš„ å·¥ä½œè€…èµ„æºæ± æ¨¡å‹ã€‚åœ¨ä¾‹å­ä¸­ï¼Œè®¾å®šäº†ä¸€å®šå¹¶å‘åº¦çš„ worker routineï¼Œè¿™äº›å‡½æ•°ä¼šä» jobs ä»»åŠ¡ é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡æ¥å¤„ç†ï¼Œå¹¶æŠŠç»“æœå‘é€åˆ° results channel ä¸­ã€‚

go è¿è¡Œæ—¶æŒ‰ç…§è‡ªå·±çš„è°ƒåº¦è§„åˆ™ï¼Œæ¥åè°ƒå¤šä¸ª worker å’Œä¸»åç¨‹ä¹‹é—´çš„è¿è¡Œã€‚ worker åç¨‹å¯åŠ¨åï¼Œç­‰å¾… jobs channel è¢«å†™å…¥æ•°æ®ã€‚å¯¹äºç†Ÿæ‚‰ javaã€c++ ç­‰å…¶å®ƒç¼–ç¨‹è¯­è¨€çš„äººæ¥è¯´ï¼Œ`for job := range jobs` éå¸¸æœ‰è¿·æƒ‘æ€§ï¼Œå®ƒå¹¶ä¸éœ€è¦ jobs çš„é•¿åº¦æ˜¯å·²çŸ¥çš„ã€‚`for range` éå¸¸ç¥å¥‡ï¼Œåœ¨ jobs channel æœ‰å€¼æ—¶æ‰è¿›è¡Œå¾ªç¯è¿­ä»£ã€‚

```
                            â”Œâ”€â”                      
                            â”‚wâ”‚                      
â”Œâ”€â”                         â”‚oâ”‚                      
â”‚mâ”‚                         â”‚râ”‚                      
â”‚aâ”‚                         â”‚kâ”‚   save               
â”‚iâ”‚               poll jobâ”€â”€â”‚eâ”‚â”€â”€resultâ”€â”€â”€â”€â”€â”        
â”‚nâ”‚               â–¼         â”‚râ”‚             â–¼        
â”‚râ”‚send job  â•”â•â•â•â•â•â•â•â•â•â•—    â”‚#â”‚â”Œâ”€â”     â•”â•â•â•â•â•â•â•â•â•â•—   
â”‚oâ”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â•‘  jobs   â•‘    â”‚1â”‚â”‚wâ”‚     â•‘ results â•‘â—€â”€â”
â”‚uâ”‚          â•šâ•â•â•â•â•â•â•â•â•â•    â””â”€â”˜â”‚oâ”‚     â•šâ•â•â•â•â•â•â•â•â•â•  â”‚
â”‚tâ”‚               â–²            â”‚râ”‚          â–²       â”‚
â”‚iâ”‚               â”‚            â”‚kâ”‚     save â”‚       â”‚
â”‚nâ”‚              poll jobâ”€â”€â”€â”€â”€â”€â”‚eâ”‚â”€â”€â”€â”€resultâ”˜       â”‚
â”‚eâ”‚                            â”‚râ”‚                  â”‚
â””â”€â”˜                            â”‚#â”‚                  â”‚
 â”‚                             â”‚2â”‚                  â”‚
 â”‚              poll           â””â”€â”˜                  â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€resultâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> æé†’ ï¼šæ³¨æ„ `worker` å‡½æ•°çš„ä¸¤ä¸ªå‚æ•°ç±»å‹çš„åŒºåˆ«ï¼Œ`jobs`ã€`out`ï¼Œä¸€ä¸ªæ˜¯ `<-chan int`ï¼Œå¦ä¸€ä¸ªæ˜¯ `chan<- string` ã€‚

ç¼–è¯‘å¹¶è¿è¡Œï¼š

```sh
âœ  go build channel.go && ./channel
å¸ƒç½® job åï¼Œå…³é—­ jobs channel
worker #2 å¯åŠ¨
worker #2 å¼€å§‹ å·¥ä½œ1
worker #1 å¯åŠ¨
worker #1 å¼€å§‹ å·¥ä½œ2
worker #1 ç»“æŸ å·¥ä½œ2
worker #1 å¼€å§‹ å·¥ä½œ3
ç»“æœ: worker #1 å·¥ä½œ2
worker #2 ç»“æŸ å·¥ä½œ1
worker #2 å¼€å§‹ å·¥ä½œ4
ç»“æœ: worker #2 å·¥ä½œ1
worker #2 ç»“æŸ å·¥ä½œ4
worker #2 å¼€å§‹ å·¥ä½œ5
ç»“æœ: worker #2 å·¥ä½œ4
worker #1 ç»“æŸ å·¥ä½œ3
worker #1 é€€å‡º
ç»“æœ: worker #1 å·¥ä½œ3
worker #2 ç»“æŸ å·¥ä½œ5
worker #2 é€€å‡º
ç»“æœ: worker #2 å·¥ä½œ5
```

> è‡ªå·±åŠ¨æ‰‹ï¼š
>
> 1. æŠŠ `jobs := make(chan int, number_of_jobs)` æ”¹ä¸º `make(chan int, 0)` ä¼šå‡ºç° â€œfatal error: all goroutines are asleep - deadlock!â€
> 2. æŠŠ `jobs := make(chan int, number_of_jobs)` æ”¹ä¸º `make(chan int, 1)`ã€`make(chan int, 2)`ï¼Œè§‚å¯Ÿ ã€å¸ƒç½® job åï¼Œå…³é—­ jobs channelã€ è¿™ä¸€å¥æ‰“å°çš„ä½ç½®

## å››ã€selectå¤šè·¯å¤ç”¨

åœ¨æŸäº›åœºæ™¯ä¸‹æˆ‘ä»¬å¯èƒ½éœ€è¦åŒæ—¶ä»å¤šä¸ªé€šé“æ¥æ”¶æ•°æ®ã€‚é€šé“åœ¨æ¥æ”¶æ•°æ®æ—¶ï¼Œå¦‚æœæ²¡æœ‰æ•°æ®å¯ä»¥è¢«æ¥æ”¶é‚£ä¹ˆå½“å‰ goroutine å°†ä¼šå‘ç”Ÿé˜»å¡ã€‚ä½ ä¹Ÿè®¸ä¼šå†™å‡ºå¦‚ä¸‹ä»£ç å°è¯•ä½¿ç”¨éå†çš„æ–¹å¼æ¥å®ç°ä»å¤šä¸ªé€šé“ä¸­æ¥æ”¶å€¼ã€‚

```go
for{
    // å°è¯•ä»ch1æ¥æ”¶å€¼
    data, ok := <-ch1
    // å°è¯•ä»ch2æ¥æ”¶å€¼
    data, ok := <-ch2
    â€¦
}
```

è¿™ç§æ–¹å¼è™½ç„¶å¯ä»¥å®ç°ä»å¤šä¸ªé€šé“æ¥æ”¶å€¼çš„éœ€æ±‚ï¼Œä½†æ˜¯ç¨‹åºçš„è¿è¡Œæ€§èƒ½ä¼šå·®å¾ˆå¤šã€‚Go è¯­è¨€å†…ç½®äº†`select`å…³é”®å­—ï¼Œä½¿ç”¨å®ƒå¯ä»¥åŒæ—¶å“åº”å¤šä¸ªé€šé“çš„æ“ä½œã€‚

Select çš„ä½¿ç”¨æ–¹å¼ç±»ä¼¼äºä¹‹å‰å­¦åˆ°çš„ switch è¯­å¥ï¼Œå®ƒä¹Ÿæœ‰ä¸€ç³»åˆ— case åˆ†æ”¯å’Œä¸€ä¸ªé»˜è®¤çš„åˆ†æ”¯ã€‚æ¯ä¸ª case åˆ†æ”¯ä¼šå¯¹åº”ä¸€ä¸ªé€šé“çš„é€šä¿¡ï¼ˆæ¥æ”¶æˆ–å‘é€ï¼‰è¿‡ç¨‹ã€‚select ä¼šä¸€ç›´ç­‰å¾…ï¼Œç›´åˆ°å…¶ä¸­çš„æŸä¸ª case çš„é€šä¿¡æ“ä½œå®Œæˆæ—¶ï¼Œå°±ä¼šæ‰§è¡Œè¯¥ case åˆ†æ”¯å¯¹åº”çš„è¯­å¥ã€‚å…·ä½“æ ¼å¼å¦‚ä¸‹ï¼š

```go
select {
case <-ch1:
	//...
case data := <-ch2:
	//...
case ch3 <- 10:
	//...
default:
	//é»˜è®¤æ“ä½œ
}
```

Select è¯­å¥å…·æœ‰ä»¥ä¸‹ç‰¹ç‚¹ã€‚

- å¯å¤„ç†ä¸€ä¸ªæˆ–å¤šä¸ª channel çš„å‘é€/æ¥æ”¶æ“ä½œã€‚
- å¦‚æœå¤šä¸ª case åŒæ—¶æ»¡è¶³ï¼Œselect ä¼š**éšæœº**é€‰æ‹©ä¸€ä¸ªæ‰§è¡Œã€‚
- å¯¹äºæ²¡æœ‰ case çš„ select ä¼šä¸€ç›´é˜»å¡ï¼Œå¯ç”¨äºé˜»å¡ main å‡½æ•°ï¼Œé˜²æ­¢é€€å‡ºã€‚

ä¸‹é¢çš„ç¤ºä¾‹ä»£ç èƒ½å¤Ÿåœ¨ç»ˆç«¯æ‰“å°å‡º10ä»¥å†…çš„å¥‡æ•°ï¼Œæˆ‘ä»¬å€ŸåŠ©è¿™ä¸ªä»£ç ç‰‡æ®µæ¥çœ‹ä¸€ä¸‹ select çš„å…·ä½“ä½¿ç”¨ã€‚

```go
package main

import "fmt"

func main() {
	ch := make(chan int, 1)
	for i := 1; i <= 10; i++ {
		select {
		case x := <-ch:
			fmt.Println(x)
		case ch <- i:
		}
	}
}
```

ä¸Šé¢çš„ä»£ç è¾“å‡ºå†…å®¹å¦‚ä¸‹ã€‚

```bash
1
3
5
7
9
```

ç¤ºä¾‹ä¸­çš„ä»£ç é¦–å…ˆæ˜¯åˆ›å»ºäº†ä¸€ä¸ªç¼“å†²åŒºå¤§å°ä¸º1çš„é€šé“ chï¼Œè¿›å…¥ for å¾ªç¯åï¼š

- ç¬¬ä¸€æ¬¡å¾ªç¯æ—¶ i = 1ï¼Œselect è¯­å¥ä¸­åŒ…å«ä¸¤ä¸ª case åˆ†æ”¯ï¼Œæ­¤æ—¶ç”±äºé€šé“ä¸­æ²¡æœ‰å€¼å¯ä»¥æ¥æ”¶ï¼Œæ‰€ä»¥`x := <-ch` è¿™ä¸ª case åˆ†æ”¯ä¸æ»¡è¶³ï¼Œè€Œ`ch <- i`è¿™ä¸ªåˆ†æ”¯å¯ä»¥æ‰§è¡Œï¼Œä¼šæŠŠ1å‘é€åˆ°é€šé“ä¸­ï¼Œç»“æŸæœ¬æ¬¡ for å¾ªç¯ï¼›
- ç¬¬äºŒæ¬¡ for å¾ªç¯æ—¶ï¼Œi = 2ï¼Œç”±äºé€šé“ç¼“å†²åŒºå·²æ»¡ï¼Œæ‰€ä»¥ `ch <- i` è¿™ä¸ªåˆ†æ”¯ä¸æ»¡è¶³ï¼Œè€Œ`x := <-ch`è¿™ä¸ªåˆ†æ”¯å¯ä»¥æ‰§è¡Œï¼Œä»é€šé“æ¥æ”¶å€¼1å¹¶èµ‹å€¼ç»™å˜é‡ x ï¼Œæ‰€ä»¥ä¼šåœ¨ç»ˆç«¯æ‰“å°å‡º 1ï¼›
- åç»­çš„ for å¾ªç¯ä»¥æ­¤ç±»æ¨ä¼šä¾æ¬¡æ‰“å°å‡º 3ã€5ã€7ã€9ã€‚

## äº”ã€é€šé“è¯¯ç”¨ç¤ºä¾‹

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å°†å±•ç¤ºä¸¤ä¸ªå› è¯¯ç”¨é€šé“å¯¼è‡´ç¨‹åºå‡ºç° bug çš„ä»£ç ç‰‡æ®µï¼Œå¸Œæœ›èƒ½å¤ŸåŠ æ·±è¯»è€…å¯¹é€šé“æ“ä½œçš„å°è±¡ã€‚

### 1ã€ç¤ºä¾‹1

å„ä½è¯»è€…å¯ä»¥æŸ¥çœ‹ä»¥ä¸‹ç¤ºä¾‹ä»£ç ï¼Œå°è¯•æ‰¾å‡ºå…¶ä¸­å­˜åœ¨çš„é—®é¢˜ã€‚

```go
// demo1 é€šé“è¯¯ç”¨å¯¼è‡´çš„bug
func demo1() {
	wg := sync.WaitGroup{}

	ch := make(chan int, 10)
	for i := 0; i < 10; i++ {
		ch <- i
	}
	close(ch)

	wg.Add(3)
	for j := 0; j < 3; j++ {
		go func() {
			for {
				task := <-ch
				// è¿™é‡Œå‡è®¾å¯¹æ¥æ”¶çš„æ•°æ®æ‰§è¡ŒæŸäº›æ“ä½œ
				fmt.Println(task)
			}
			wg.Done()
		}()
	}
	wg.Wait()
}
```

å°†ä¸Šè¿°ä»£ç ç¼–è¯‘æ‰§è¡Œåï¼ŒåŒ¿åå‡½æ•°æ‰€åœ¨çš„ goroutine å¹¶ä¸ä¼šæŒ‰ç…§é¢„æœŸåœ¨é€šé“è¢«å…³é—­åé€€å‡ºã€‚å› ä¸º`task := <- ch`çš„æ¥æ”¶æ“ä½œåœ¨é€šé“è¢«å…³é—­åä¼šä¸€ç›´æ¥æ”¶åˆ°é›¶å€¼ï¼Œè€Œä¸ä¼šé€€å‡ºã€‚æ­¤å¤„çš„æ¥æ”¶æ“ä½œåº”è¯¥ä½¿ç”¨`task, ok := <- ch`ï¼Œé€šè¿‡åˆ¤æ–­å¸ƒå°”å€¼`ok`ä¸ºå‡æ—¶é€€å‡ºï¼›æˆ–è€…ä½¿ç”¨select æ¥å¤„ç†é€šé“ã€‚

### 2ã€ç¤ºä¾‹2

å„ä½è¯»è€…é˜…è¯»ä¸‹æ–¹ä»£ç ç‰‡æ®µï¼Œå°è¯•æ‰¾å‡ºå…¶ä¸­å­˜åœ¨çš„é—®é¢˜ã€‚

```go
// demo2 é€šé“è¯¯ç”¨å¯¼è‡´çš„bug
func demo2() {
	ch := make(chan string)
	go func() {
		// è¿™é‡Œå‡è®¾æ‰§è¡Œä¸€äº›è€—æ—¶çš„æ“ä½œ
		time.Sleep(3 * time.Second)
		ch <- "job result"
	}()

	select {
	case result := <-ch:
		fmt.Println(result)
	case <-time.After(time.Second): // è¾ƒå°çš„è¶…æ—¶æ—¶é—´
		return
	}
}
```

ä¸Šè¿°ä»£ç ç‰‡æ®µå¯èƒ½å¯¼è‡´ goroutine æ³„éœ²ï¼ˆgoroutine å¹¶æœªæŒ‰é¢„æœŸé€€å‡ºå¹¶é”€æ¯ï¼‰ã€‚ç”±äº select å‘½ä¸­äº†è¶…æ—¶é€»è¾‘ï¼Œå¯¼è‡´é€šé“æ²¡æœ‰æ¶ˆè´¹è€…ï¼ˆæ— æ¥æ”¶æ“ä½œï¼‰ï¼Œè€Œå…¶å®šä¹‰çš„é€šé“ä¸ºæ— ç¼“å†²é€šé“ï¼Œå› æ­¤ goroutine ä¸­çš„`ch <- "job result"`æ“ä½œä¼šä¸€ç›´é˜»å¡ï¼Œæœ€ç»ˆå¯¼è‡´ goroutine æ³„éœ²ã€‚

## å…­ã€å¹¶å‘å®‰å…¨å’Œé”

æœ‰æ—¶å€™æˆ‘ä»¬çš„ä»£ç ä¸­å¯èƒ½ä¼šå­˜åœ¨å¤šä¸ª goroutine åŒæ—¶æ“ä½œä¸€ä¸ªèµ„æºï¼ˆä¸´ç•ŒåŒºï¼‰çš„æƒ…å†µï¼Œè¿™ç§æƒ…å†µä¸‹å°±ä¼šå‘ç”Ÿ`ç«æ€é—®é¢˜`ï¼ˆæ•°æ®ç«æ€ï¼‰ã€‚è¿™å°±å¥½æ¯”ç°å®ç”Ÿæ´»ä¸­åå­—è·¯å£è¢«å„ä¸ªæ–¹å‘çš„æ±½è½¦ç«äº‰ï¼Œè¿˜æœ‰ç«è½¦ä¸Šçš„å«ç”Ÿé—´è¢«è½¦å¢é‡Œçš„äººç«äº‰ã€‚

æˆ‘ä»¬ç”¨ä¸‹é¢çš„ä»£ç æ¼”ç¤ºä¸€ä¸ªæ•°æ®ç«äº‰çš„ç¤ºä¾‹ã€‚

```go
package main

import (
	"fmt"
	"sync"
)

var (
	x int64

	wg sync.WaitGroup // ç­‰å¾…ç»„
)

// add å¯¹å…¨å±€å˜é‡xæ‰§è¡Œ5000æ¬¡åŠ 1æ“ä½œ
func add() {
	for i := 0; i < 5000; i++ {
		x = x + 1
	}
	wg.Done()
}

func main() {
	wg.Add(2)

	go add()
	go add()

	wg.Wait()
	fmt.Println(x)
}
```

æˆ‘ä»¬å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘åæ‰§è¡Œï¼Œä¸å‡ºæ„å¤–æ¯æ¬¡æ‰§è¡Œéƒ½ä¼šè¾“å‡ºè¯¸å¦‚9537ã€5865ã€6527ç­‰ä¸åŒçš„ç»“æœã€‚è¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä»£ç ç‰‡ä¸­ï¼Œæˆ‘ä»¬å¼€å¯äº†ä¸¤ä¸ª goroutine åˆ†åˆ«æ‰§è¡Œ add å‡½æ•°ï¼Œè¿™ä¸¤ä¸ª goroutine åœ¨è®¿é—®å’Œä¿®æ”¹å…¨å±€çš„`x`å˜é‡æ—¶å°±ä¼šå­˜åœ¨æ•°æ®ç«äº‰ï¼ŒæŸä¸ª goroutine ä¸­å¯¹å…¨å±€å˜é‡`x`çš„ä¿®æ”¹å¯èƒ½ä¼šè¦†ç›–æ‰å¦ä¸€ä¸ª goroutine ä¸­çš„æ“ä½œï¼Œæ‰€ä»¥å¯¼è‡´æœ€åçš„ç»“æœä¸é¢„æœŸä¸ç¬¦ã€‚

### 6.1 äº’æ–¥é”

äº’æ–¥é”æ˜¯ä¸€ç§å¸¸ç”¨çš„æ§åˆ¶å…±äº«èµ„æºè®¿é—®çš„æ–¹æ³•ï¼Œå®ƒèƒ½å¤Ÿä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ª goroutine å¯ä»¥è®¿é—®å…±äº«èµ„æºã€‚Go è¯­è¨€ä¸­ä½¿ç”¨`sync`åŒ…ä¸­æä¾›çš„`Mutex`ç±»å‹æ¥å®ç°äº’æ–¥é”ã€‚

`sync.Mutex`æä¾›äº†ä¸¤ä¸ªæ–¹æ³•ä¾›æˆ‘ä»¬ä½¿ç”¨ã€‚

| æ–¹æ³•å                     |    åŠŸèƒ½    |
| :------------------------- | :--------: |
| `func (m *Mutex) Lock()`   | è·å–äº’æ–¥é” |
| `func (m *Mutex) Unlock()` | é‡Šæ”¾äº’æ–¥é” |

æˆ‘ä»¬åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä¸­ä½¿ç”¨äº’æ–¥é”é™åˆ¶æ¯æ¬¡åªæœ‰ä¸€ä¸ª goroutine æ‰èƒ½ä¿®æ”¹å…¨å±€å˜é‡`x`ï¼Œä»è€Œä¿®å¤ä¸Šé¢ä»£ç ä¸­çš„é—®é¢˜ã€‚

```go
package main

import (
	"fmt"
	"sync"
)

// sync.Mutex

var (
	x int64

	wg sync.WaitGroup // ç­‰å¾…ç»„

	m sync.Mutex // äº’æ–¥é”
)

// add å¯¹å…¨å±€å˜é‡xæ‰§è¡Œ5000æ¬¡åŠ 1æ“ä½œ
func add() {
	for i := 0; i < 5000; i++ {
		m.Lock() // ä¿®æ”¹xå‰åŠ é”
		x = x + 1
		m.Unlock() // æ”¹å®Œè§£é”
	}
	wg.Done()
}

func main() {
	wg.Add(2)

	go add()
	go add()

	wg.Wait()
	fmt.Println(x)
}
```

å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘åå¤šæ¬¡æ‰§è¡Œï¼Œæ¯ä¸€æ¬¡éƒ½ä¼šå¾—åˆ°é¢„æœŸä¸­çš„ç»“æœâ€”â€”10000ã€‚

ä½¿ç”¨äº’æ–¥é”èƒ½å¤Ÿä¿è¯åŒä¸€æ—¶é—´æœ‰ä¸”åªæœ‰ä¸€ä¸ª goroutine è¿›å…¥ä¸´ç•ŒåŒºï¼Œå…¶ä»–çš„ goroutine åˆ™åœ¨ç­‰å¾…é”ï¼›å½“äº’æ–¥é”é‡Šæ”¾åï¼Œç­‰å¾…çš„ goroutine æ‰å¯ä»¥è·å–é”è¿›å…¥ä¸´ç•ŒåŒºï¼Œå¤šä¸ª goroutine åŒæ—¶ç­‰å¾…ä¸€ä¸ªé”æ—¶ï¼Œå”¤é†’çš„ç­–ç•¥æ˜¯éšæœºçš„ã€‚

### 6.2 è¯»å†™äº’æ–¥é”

äº’æ–¥é”æ˜¯å®Œå…¨äº’æ–¥çš„ï¼Œä½†æ˜¯å®é™…ä¸Šæœ‰å¾ˆå¤šåœºæ™¯æ˜¯è¯»å¤šå†™å°‘çš„ï¼Œå½“æˆ‘ä»¬å¹¶å‘çš„å»è¯»å–ä¸€ä¸ªèµ„æºè€Œä¸æ¶‰åŠèµ„æºä¿®æ”¹çš„æ—¶å€™æ˜¯æ²¡æœ‰å¿…è¦åŠ äº’æ–¥é”çš„ï¼Œè¿™ç§åœºæ™¯ä¸‹ä½¿ç”¨è¯»å†™é”æ˜¯æ›´å¥½çš„ä¸€ç§é€‰æ‹©ã€‚è¯»å†™é”åœ¨ Go è¯­è¨€ä¸­ä½¿ç”¨`sync`åŒ…ä¸­çš„`RWMutex`ç±»å‹ã€‚

`sync.RWMutex`æä¾›äº†ä»¥ä¸‹5ä¸ªæ–¹æ³•ã€‚

| æ–¹æ³•å                                |              åŠŸèƒ½              |
| :------------------------------------ | :----------------------------: |
| `func (rw *RWMutex) Lock()`           |            è·å–å†™é”            |
| `func (rw *RWMutex) Unlock()`         |            é‡Šæ”¾å†™é”            |
| `func (rw *RWMutex) RLock()`          |            è·å–è¯»é”            |
| `func (rw *RWMutex) RUnlock()`        |            é‡Šæ”¾è¯»é”            |
| `func (rw *RWMutex) RLocker() Locker` | è¿”å›ä¸€ä¸ªå®ç°Lockeræ¥å£çš„è¯»å†™é” |

è¯»å†™é”åˆ†ä¸ºä¸¤ç§ï¼šè¯»é”å’Œå†™é”ã€‚å½“ä¸€ä¸ª goroutine è·å–åˆ°è¯»é”ä¹‹åï¼Œå…¶ä»–çš„ goroutine å¦‚æœæ˜¯è·å–è¯»é”ä¼šç»§ç»­è·å¾—é”ï¼Œå¦‚æœæ˜¯è·å–å†™é”å°±ä¼šç­‰å¾…ï¼›è€Œå½“ä¸€ä¸ª goroutine è·å–å†™é”ä¹‹åï¼Œå…¶ä»–çš„ goroutine æ— è®ºæ˜¯è·å–è¯»é”è¿˜æ˜¯å†™é”éƒ½ä¼šç­‰å¾…ã€‚

ä¸‹é¢æˆ‘ä»¬ä½¿ç”¨ä»£ç æ„é€ ä¸€ä¸ªè¯»å¤šå†™å°‘çš„åœºæ™¯ï¼Œç„¶ååˆ†åˆ«ä½¿ç”¨äº’æ–¥é”å’Œè¯»å†™é”æŸ¥çœ‹å®ƒä»¬çš„æ€§èƒ½å·®å¼‚ã€‚

```go
var (
	x       int64
	wg      sync.WaitGroup
	mutex   sync.Mutex
	rwMutex sync.RWMutex
)

// writeWithLock ä½¿ç”¨äº’æ–¥é”çš„å†™æ“ä½œ
func writeWithLock() {
	mutex.Lock() // åŠ äº’æ–¥é”
	x = x + 1
	time.Sleep(10 * time.Millisecond) // å‡è®¾è¯»æ“ä½œè€—æ—¶10æ¯«ç§’
	mutex.Unlock()                    // è§£äº’æ–¥é”
	wg.Done()
}

// readWithLock ä½¿ç”¨äº’æ–¥é”çš„è¯»æ“ä½œ
func readWithLock() {
	mutex.Lock()                 // åŠ äº’æ–¥é”
	time.Sleep(time.Millisecond) // å‡è®¾è¯»æ“ä½œè€—æ—¶1æ¯«ç§’
	mutex.Unlock()               // é‡Šæ”¾äº’æ–¥é”
	wg.Done()
}

// writeWithLock ä½¿ç”¨è¯»å†™äº’æ–¥é”çš„å†™æ“ä½œ
func writeWithRWLock() {
	rwMutex.Lock() // åŠ å†™é”
	x = x + 1
	time.Sleep(10 * time.Millisecond) // å‡è®¾è¯»æ“ä½œè€—æ—¶10æ¯«ç§’
	rwMutex.Unlock()                  // é‡Šæ”¾å†™é”
	wg.Done()
}

// readWithRWLock ä½¿ç”¨è¯»å†™äº’æ–¥é”çš„è¯»æ“ä½œ
func readWithRWLock() {
	rwMutex.RLock()              // åŠ è¯»é”
	time.Sleep(time.Millisecond) // å‡è®¾è¯»æ“ä½œè€—æ—¶1æ¯«ç§’
	rwMutex.RUnlock()            // é‡Šæ”¾è¯»é”
	wg.Done()
}

func do(wf, rf func(), wc, rc int) {
	start := time.Now()
	// wcä¸ªå¹¶å‘å†™æ“ä½œ
	for i := 0; i < wc; i++ {
		wg.Add(1)
		go wf()
	}

	//  rcä¸ªå¹¶å‘è¯»æ“ä½œ
	for i := 0; i < rc; i++ {
		wg.Add(1)
		go rf()
	}

	wg.Wait()
	cost := time.Since(start)
	fmt.Printf("x:%v cost:%v\n", x, cost)

}
```

æˆ‘ä»¬å‡è®¾æ¯ä¸€æ¬¡è¯»æ“ä½œéƒ½ä¼šè€—æ—¶1msï¼Œè€Œæ¯ä¸€æ¬¡å†™æ“ä½œä¼šè€—æ—¶10msï¼Œæˆ‘ä»¬åˆ†åˆ«æµ‹è¯•ä½¿ç”¨äº’æ–¥é”å’Œè¯»å†™äº’æ–¥é”æ‰§è¡Œ10æ¬¡å¹¶å‘å†™å’Œ1000æ¬¡å¹¶å‘è¯»çš„è€—æ—¶æ•°æ®ã€‚

```go
// ä½¿ç”¨äº’æ–¥é”ï¼Œ10å¹¶å‘å†™ï¼Œ1000å¹¶å‘è¯»
do(writeWithLock, readWithLock, 10, 1000) // x:10 cost:1.466500951s

// ä½¿ç”¨è¯»å†™äº’æ–¥é”ï¼Œ10å¹¶å‘å†™ï¼Œ1000å¹¶å‘è¯»
do(writeWithRWLock, readWithRWLock, 10, 1000) // x:10 cost:117.207592ms
```

ä»æœ€ç»ˆçš„æ‰§è¡Œç»“æœå¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨è¯»å†™äº’æ–¥é”åœ¨è¯»å¤šå†™å°‘çš„åœºæ™¯ä¸‹èƒ½å¤Ÿæå¤§åœ°æé«˜ç¨‹åºçš„æ€§èƒ½ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœä¸€ä¸ªç¨‹åºä¸­çš„è¯»æ“ä½œå’Œå†™æ“ä½œæ•°é‡çº§å·®åˆ«ä¸å¤§ï¼Œé‚£ä¹ˆè¯»å†™äº’æ–¥é”çš„ä¼˜åŠ¿å°±å‘æŒ¥ä¸å‡ºæ¥ã€‚

### 6.3 sync.WaitGroup

åœ¨ä»£ç ä¸­ç”Ÿç¡¬çš„ä½¿ç”¨`time.Sleep`è‚¯å®šæ˜¯ä¸åˆé€‚çš„ï¼ŒGoè¯­è¨€ä¸­å¯ä»¥ä½¿ç”¨`sync.WaitGroup`æ¥å®ç°å¹¶å‘ä»»åŠ¡çš„åŒæ­¥ã€‚ `sync.WaitGroup`æœ‰ä»¥ä¸‹å‡ ä¸ªæ–¹æ³•ï¼š

| æ–¹æ³•å                                 |        åŠŸèƒ½         |
| :------------------------------------- | :-----------------: |
| `func (wg * WaitGroup) Add(delta int)` |    è®¡æ•°å™¨+delta     |
| `(wg *WaitGroup) Done()`               |      è®¡æ•°å™¨-1       |
| `(wg *WaitGroup) Wait()`               | é˜»å¡ç›´åˆ°è®¡æ•°å™¨å˜ä¸º0 |

`sync.WaitGroup`å†…éƒ¨ç»´æŠ¤ç€ä¸€ä¸ªè®¡æ•°å™¨ï¼Œè®¡æ•°å™¨çš„å€¼å¯ä»¥å¢åŠ å’Œå‡å°‘ã€‚ä¾‹å¦‚å½“æˆ‘ä»¬å¯åŠ¨äº† N ä¸ªå¹¶å‘ä»»åŠ¡æ—¶ï¼Œå°±å°†è®¡æ•°å™¨å€¼å¢åŠ Nã€‚æ¯ä¸ªä»»åŠ¡å®Œæˆæ—¶é€šè¿‡è°ƒç”¨ Done æ–¹æ³•å°†è®¡æ•°å™¨å‡1ã€‚é€šè¿‡è°ƒç”¨ Wait æ¥ç­‰å¾…å¹¶å‘ä»»åŠ¡æ‰§è¡Œå®Œï¼Œå½“è®¡æ•°å™¨å€¼ä¸º 0 æ—¶ï¼Œè¡¨ç¤ºæ‰€æœ‰å¹¶å‘ä»»åŠ¡å·²ç»å®Œæˆã€‚

æˆ‘ä»¬åˆ©ç”¨`sync.WaitGroup`å°†ä¸Šé¢çš„ä»£ç ä¼˜åŒ–ä¸€ä¸‹ï¼š

```go
var wg sync.WaitGroup

func hello() {
	defer wg.Done()
	fmt.Println("Hello Goroutine!")
}
func main() {
	wg.Add(1)
	go hello() // å¯åŠ¨å¦å¤–ä¸€ä¸ªgoroutineå»æ‰§è¡Œhelloå‡½æ•°
	fmt.Println("main goroutine done!")
	wg.Wait()
}
```

éœ€è¦æ³¨æ„`sync.WaitGroup`æ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿›è¡Œå‚æ•°ä¼ é€’çš„æ—¶å€™è¦ä¼ é€’æŒ‡é’ˆã€‚

### 6.4 sync.Once

åœ¨æŸäº›åœºæ™¯ä¸‹æˆ‘ä»¬éœ€è¦ç¡®ä¿æŸäº›æ“ä½œå³ä½¿åœ¨é«˜å¹¶å‘çš„åœºæ™¯ä¸‹ä¹Ÿåªä¼šè¢«æ‰§è¡Œä¸€æ¬¡ï¼Œä¾‹å¦‚åªåŠ è½½ä¸€æ¬¡é…ç½®æ–‡ä»¶ç­‰ã€‚

Goè¯­è¨€ä¸­çš„`sync`åŒ…ä¸­æä¾›äº†ä¸€ä¸ªé’ˆå¯¹åªæ‰§è¡Œä¸€æ¬¡åœºæ™¯çš„è§£å†³æ–¹æ¡ˆâ€”â€”`sync.Once`ï¼Œ`sync.Once`åªæœ‰ä¸€ä¸ª`Do`æ–¹æ³•ï¼Œå…¶ç­¾åå¦‚ä¸‹ï¼š

```go
func (o *Once) Do(f func())
```

**æ³¨æ„ï¼š**å¦‚æœè¦æ‰§è¡Œçš„å‡½æ•°`f`éœ€è¦ä¼ é€’å‚æ•°å°±éœ€è¦æ­é…é—­åŒ…æ¥ä½¿ç”¨ã€‚

#### 6.4.1 åŠ è½½é…ç½®æ–‡ä»¶ç¤ºä¾‹

å»¶è¿Ÿä¸€ä¸ªå¼€é”€å¾ˆå¤§çš„åˆå§‹åŒ–æ“ä½œåˆ°çœŸæ­£ç”¨åˆ°å®ƒçš„æ—¶å€™å†æ‰§è¡Œæ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®è·µã€‚å› ä¸ºé¢„å…ˆåˆå§‹åŒ–ä¸€ä¸ªå˜é‡ï¼ˆæ¯”å¦‚åœ¨initå‡½æ•°ä¸­å®Œæˆåˆå§‹åŒ–ï¼‰ä¼šå¢åŠ ç¨‹åºçš„å¯åŠ¨è€—æ—¶ï¼Œè€Œä¸”æœ‰å¯èƒ½å®é™…æ‰§è¡Œè¿‡ç¨‹ä¸­è¿™ä¸ªå˜é‡æ²¡æœ‰ç”¨ä¸Šï¼Œé‚£ä¹ˆè¿™ä¸ªåˆå§‹åŒ–æ“ä½œå°±ä¸æ˜¯å¿…é¡»è¦åšçš„ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼š

```go
var icons map[string]image.Image

func loadIcons() {
	icons = map[string]image.Image{
		"left":  loadIcon("left.png"),
		"up":    loadIcon("up.png"),
		"right": loadIcon("right.png"),
		"down":  loadIcon("down.png"),
	}
}

// Icon è¢«å¤šä¸ªgoroutineè°ƒç”¨æ—¶ä¸æ˜¯å¹¶å‘å®‰å…¨çš„
func Icon(name string) image.Image {
	if icons == nil {
		loadIcons()
	}
	return icons[name]
}
```

å¤šä¸ª goroutine å¹¶å‘è°ƒç”¨Iconå‡½æ•°æ—¶ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œç°ä»£çš„ç¼–è¯‘å™¨å’ŒCPUå¯èƒ½ä¼šåœ¨ä¿è¯æ¯ä¸ª goroutine éƒ½æ»¡è¶³ä¸²è¡Œä¸€è‡´çš„åŸºç¡€ä¸Šè‡ªç”±åœ°é‡æ’è®¿é—®å†…å­˜çš„é¡ºåºã€‚loadIconså‡½æ•°å¯èƒ½ä¼šè¢«é‡æ’ä¸ºä»¥ä¸‹ç»“æœï¼š

```go
func loadIcons() {
	icons = make(map[string]image.Image)
	icons["left"] = loadIcon("left.png")
	icons["up"] = loadIcon("up.png")
	icons["right"] = loadIcon("right.png")
	icons["down"] = loadIcon("down.png")
}
```

åœ¨è¿™ç§æƒ…å†µä¸‹å°±ä¼šå‡ºç°å³ä½¿åˆ¤æ–­äº†`icons`ä¸æ˜¯nilä¹Ÿä¸æ„å‘³ç€å˜é‡åˆå§‹åŒ–å®Œæˆäº†ã€‚è€ƒè™‘åˆ°è¿™ç§æƒ…å†µï¼Œæˆ‘ä»¬èƒ½æƒ³åˆ°çš„åŠæ³•å°±æ˜¯æ·»åŠ äº’æ–¥é”ï¼Œä¿è¯åˆå§‹åŒ–`icons`çš„æ—¶å€™ä¸ä¼šè¢«å…¶ä»–çš„ goroutine æ“ä½œï¼Œä½†æ˜¯è¿™æ ·åšåˆä¼šå¼•å‘æ€§èƒ½é—®é¢˜ã€‚

ä½¿ç”¨`sync.Once`æ”¹é€ çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š

```go
var icons map[string]image.Image

var loadIconsOnce sync.Once

func loadIcons() {
	icons = map[string]image.Image{
		"left":  loadIcon("left.png"),
		"up":    loadIcon("up.png"),
		"right": loadIcon("right.png"),
		"down":  loadIcon("down.png"),
	}
}

// Icon æ˜¯å¹¶å‘å®‰å…¨çš„
func Icon(name string) image.Image {
	loadIconsOnce.Do(loadIcons)
	return icons[name]
}
```

#### 6.4.2 å¹¶å‘å®‰å…¨çš„å•ä¾‹æ¨¡å¼

ä¸‹é¢æ˜¯å€ŸåŠ©`sync.Once`å®ç°çš„å¹¶å‘å®‰å…¨çš„å•ä¾‹æ¨¡å¼ï¼š

```go
package singleton

import (
    "sync"
)

type singleton struct {}

var instance *singleton
var once sync.Once

func GetInstance() *singleton {
    once.Do(func() {
        instance = &singleton{}
    })
    return instance
}
```

`sync.Once`å…¶å®å†…éƒ¨åŒ…å«ä¸€ä¸ªäº’æ–¥é”å’Œä¸€ä¸ªå¸ƒå°”å€¼ï¼Œäº’æ–¥é”ä¿è¯å¸ƒå°”å€¼å’Œæ•°æ®çš„å®‰å…¨ï¼Œè€Œå¸ƒå°”å€¼ç”¨æ¥è®°å½•åˆå§‹åŒ–æ˜¯å¦å®Œæˆã€‚è¿™æ ·è®¾è®¡å°±èƒ½ä¿è¯åˆå§‹åŒ–æ“ä½œçš„æ—¶å€™æ˜¯å¹¶å‘å®‰å…¨çš„å¹¶ä¸”åˆå§‹åŒ–æ“ä½œä¹Ÿä¸ä¼šè¢«æ‰§è¡Œå¤šæ¬¡ã€‚

### 6.5 sync.Map

Go è¯­è¨€ä¸­å†…ç½®çš„ map ä¸æ˜¯å¹¶å‘å®‰å…¨çš„ï¼Œè¯·çœ‹ä¸‹é¢è¿™æ®µç¤ºä¾‹ä»£ç ã€‚

```go
package main

import (
	"fmt"
	"strconv"
	"sync"
)

var m = make(map[string]int)

func get(key string) int {
	return m[key]
}

func set(key string, value int) {
	m[key] = value
}

func main() {
	wg := sync.WaitGroup{}
	for i := 0; i < 10; i++ {
		wg.Add(1)
		go func(n int) {
			key := strconv.Itoa(n)
			set(key, n)
			fmt.Printf("k=:%v,v:=%v\n", key, get(key))
			wg.Done()
		}(i)
	}
	wg.Wait()
}
```

å°†ä¸Šé¢çš„ä»£ç ç¼–è¯‘åæ‰§è¡Œï¼Œä¼šæŠ¥å‡º`fatal error: concurrent map writes`é”™è¯¯ã€‚æˆ‘ä»¬ä¸èƒ½åœ¨å¤šä¸ª goroutine ä¸­å¹¶å‘å¯¹å†…ç½®çš„ map è¿›è¡Œè¯»å†™æ“ä½œï¼Œå¦åˆ™ä¼šå­˜åœ¨æ•°æ®ç«äº‰é—®é¢˜ã€‚

åƒè¿™ç§åœºæ™¯ä¸‹å°±éœ€è¦ä¸º map åŠ é”æ¥ä¿è¯å¹¶å‘çš„å®‰å…¨æ€§äº†ï¼ŒGoè¯­è¨€çš„`sync`åŒ…ä¸­æä¾›äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„å¹¶å‘å®‰å…¨ç‰ˆ mapâ€”â€”`sync.Map`ã€‚å¼€ç®±å³ç”¨è¡¨ç¤ºå…¶ä¸ç”¨åƒå†…ç½®çš„ map ä¸€æ ·ä½¿ç”¨ make å‡½æ•°åˆå§‹åŒ–å°±èƒ½ç›´æ¥ä½¿ç”¨ã€‚åŒæ—¶`sync.Map`å†…ç½®äº†è¯¸å¦‚`Store`ã€`Load`ã€`LoadOrStore`ã€`Delete`ã€`Range`ç­‰æ“ä½œæ–¹æ³•ã€‚

| æ–¹æ³•å                                                       |              åŠŸèƒ½               |
| :----------------------------------------------------------- | :-----------------------------: |
| `func (m *Map) Store(key, value interface{})`                |        å­˜å‚¨key-valueæ•°æ®        |
| `func (m *Map) Load(key interface{}) (value interface{}, ok bool)` |       æŸ¥è¯¢keyå¯¹åº”çš„value        |
| `func (m *Map) LoadOrStore(key, value interface{}) (actual interface{}, loaded bool)` |    æŸ¥è¯¢æˆ–å­˜å‚¨keyå¯¹åº”çš„value     |
| `func (m *Map) LoadAndDelete(key interface{}) (value interface{}, loaded bool)` |          æŸ¥è¯¢å¹¶åˆ é™¤key          |
| `func (m *Map) Delete(key interface{})`                      |             åˆ é™¤key             |
| `func (m *Map) Range(f func(key, value interface{}) bool)`   | å¯¹mapä¸­çš„æ¯ä¸ªkey-valueä¾æ¬¡è°ƒç”¨f |

ä¸‹é¢çš„ä»£ç ç¤ºä¾‹æ¼”ç¤ºäº†å¹¶å‘è¯»å†™`sync.Map`ã€‚

```go
package main

import (
	"fmt"
	"strconv"
	"sync"
)

// å¹¶å‘å®‰å…¨çš„map
var m = sync.Map{}

func main() {
	wg := sync.WaitGroup{}
	// å¯¹mæ‰§è¡Œ20ä¸ªå¹¶å‘çš„è¯»å†™æ“ä½œ
	for i := 0; i < 20; i++ {
		wg.Add(1)
		go func(n int) {
			key := strconv.Itoa(n)
			m.Store(key, n)         // å­˜å‚¨key-value
			value, _ := m.Load(key) // æ ¹æ®keyå–å€¼
			fmt.Printf("k=:%v,v:=%v\n", key, value)
			wg.Done()
		}(i)
	}
	wg.Wait()
}
```

## ä¸ƒã€åŸå­æ“ä½œ

é’ˆå¯¹æ•´æ•°æ•°æ®ç±»å‹ï¼ˆint32ã€uint32ã€int64ã€uint64ï¼‰æˆ‘ä»¬è¿˜å¯ä»¥ä½¿ç”¨åŸå­æ“ä½œæ¥ä¿è¯å¹¶å‘å®‰å…¨ï¼Œé€šå¸¸ç›´æ¥ä½¿ç”¨åŸå­æ“ä½œæ¯”ä½¿ç”¨é”æ“ä½œæ•ˆç‡æ›´é«˜ã€‚Goè¯­è¨€ä¸­åŸå­æ“ä½œç”±å†…ç½®çš„æ ‡å‡†åº“`sync/atomic`æä¾›ã€‚

### 7.1 atomicåŒ…

| æ–¹æ³•                                                         |      è§£é‡Š      |
| :----------------------------------------------------------- | :------------: |
| `func LoadInt32(addr *int32) (val int32)` <br />`func LoadInt64(addr *int64) (val int64)` <br />`func LoadUint32(addr *uint32) (val uint32)` <br />`func LoadUint64(addr *uint64) (val uint64)` <br />`func LoadUintptr(addr *uintptr) (val uintptr)` <br />`func LoadPointer(addr *unsafe.Pointer) (val unsafe.Pointer)` |    è¯»å–æ“ä½œ    |
| `func StoreInt32(addr *int32, val int32)` <br />`func StoreInt64(addr *int64, val int64)` <br />`func StoreUint32(addr *uint32, val uint32)` <br />`func StoreUint64(addr *uint64, val uint64)` <br />`func StoreUintptr(addr *uintptr, val uintptr)` <br />`func StorePointer(addr *unsafe.Pointer, val unsafe.Pointer)` |    å†™å…¥æ“ä½œ    |
| `func AddInt32(addr *int32, delta int32) (new int32)` <br />`func AddInt64(addr *int64, delta int64) (new int64)` <br />`func AddUint32(addr *uint32, delta uint32) (new uint32)` <br />`func AddUint64(addr *uint64, delta uint64) (new uint64)` <br />`func AddUintptr(addr *uintptr, delta uintptr) (new uintptr)` |    ä¿®æ”¹æ“ä½œ    |
| `func SwapInt32(addr *int32, new int32) (old int32)` <br />`func SwapInt64(addr *int64, new int64) (old int64)` <br />`func SwapUint32(addr *uint32, new uint32) (old uint32)` <br />`func SwapUint64(addr *uint64, new uint64) (old uint64)` <br />`func SwapUintptr(addr *uintptr, new uintptr) (old uintptr)` <br />`func SwapPointer(addr *unsafe.Pointer, new unsafe.Pointer) (old unsafe.Pointer)` |    äº¤æ¢æ“ä½œ    |
| `func CompareAndSwapInt32(addr *int32, old, new int32) (swapped bool)` <br />`func CompareAndSwapInt64(addr *int64, old, new int64) (swapped bool)` <br />`func CompareAndSwapUint32(addr *uint32, old, new uint32) (swapped bool)` <br />`func CompareAndSwapUint64(addr *uint64, old, new uint64) (swapped bool)` <br />`func CompareAndSwapUintptr(addr *uintptr, old, new uintptr) (swapped bool)` <br />`func CompareAndSwapPointer(addr *unsafe.Pointer, old, new unsafe.Pointer) (swapped bool)` | æ¯”è¾ƒå¹¶äº¤æ¢æ“ä½œ |

### 7.2 ç¤ºä¾‹

æˆ‘ä»¬å¡«å†™ä¸€ä¸ªç¤ºä¾‹æ¥æ¯”è¾ƒä¸‹äº’æ–¥é”å’ŒåŸå­æ“ä½œçš„æ€§èƒ½ã€‚

```go
package main

import (
	"fmt"
	"sync"
	"sync/atomic"
	"time"
)

type Counter interface {
	Inc()
	Load() int64
}

// æ™®é€šç‰ˆ
type CommonCounter struct {
	counter int64
}

func (c CommonCounter) Inc() {
	c.counter++
}

func (c CommonCounter) Load() int64 {
	return c.counter
}

// äº’æ–¥é”ç‰ˆ
type MutexCounter struct {
	counter int64
	lock    sync.Mutex
}

func (m *MutexCounter) Inc() {
	m.lock.Lock()
	defer m.lock.Unlock()
	m.counter++
}

func (m *MutexCounter) Load() int64 {
	m.lock.Lock()
	defer m.lock.Unlock()
	return m.counter
}

// åŸå­æ“ä½œç‰ˆ
type AtomicCounter struct {
	counter int64
}

func (a *AtomicCounter) Inc() {
	atomic.AddInt64(&a.counter, 1)
}

func (a *AtomicCounter) Load() int64 {
	return atomic.LoadInt64(&a.counter)
}

func test(c Counter) {
	var wg sync.WaitGroup
	start := time.Now()
	for i := 0; i < 1000; i++ {
		wg.Add(1)
		go func() {
			c.Inc()
			wg.Done()
		}()
	}
	wg.Wait()
	end := time.Now()
	fmt.Println(c.Load(), end.Sub(start))
}

func main() {
	c1 := CommonCounter{} // éå¹¶å‘å®‰å…¨
	test(c1)
	c2 := MutexCounter{} // ä½¿ç”¨äº’æ–¥é”å®ç°å¹¶å‘å®‰å…¨
	test(&c2)
	c3 := AtomicCounter{} // å¹¶å‘å®‰å…¨ä¸”æ¯”äº’æ–¥é”æ•ˆç‡æ›´é«˜
	test(&c3)
}
```

`atomic`åŒ…æä¾›äº†åº•å±‚çš„åŸå­çº§å†…å­˜æ“ä½œï¼Œå¯¹äºåŒæ­¥ç®—æ³•çš„å®ç°å¾ˆæœ‰ç”¨ã€‚è¿™äº›å‡½æ•°å¿…é¡»è°¨æ…åœ°ä¿è¯æ­£ç¡®ä½¿ç”¨ã€‚é™¤äº†æŸäº›ç‰¹æ®Šçš„åº•å±‚åº”ç”¨ï¼Œä½¿ç”¨é€šé“æˆ–è€… sync åŒ…çš„å‡½æ•°/ç±»å‹å®ç°åŒæ­¥æ›´å¥½ã€‚

## å…«ã€ç»ƒä¹ é¢˜

ä½¿ç”¨ goroutine å’Œ channel å®ç°ä¸€ä¸ªè®¡ç®—int64éšæœºæ•°å„ä½æ•°å’Œçš„ç¨‹åºï¼Œä¾‹å¦‚ç”Ÿæˆéšæœºæ•°61345ï¼Œè®¡ç®—å…¶æ¯ä¸ªä½æ•°ä¸Šçš„æ•°å­—ä¹‹å’Œä¸º19ã€‚

- å¼€å¯ä¸€ä¸ª goroutine å¾ªç¯ç”Ÿæˆint64ç±»å‹çš„éšæœºæ•°ï¼Œå‘é€åˆ°`jobChan`
- å¼€å¯24ä¸ª goroutine ä»`jobChan`ä¸­å–å‡ºéšæœºæ•°è®¡ç®—å„ä½æ•°çš„å’Œï¼Œå°†ç»“æœå‘é€åˆ°`resultChan`
- ä¸» goroutine ä»`resultChan`å–å‡ºç»“æœå¹¶æ‰“å°åˆ°ç»ˆç«¯è¾“å‡º



## å‚è€ƒ

- [Channel](https://www.topgoer.com/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/channel.html)

- [Go Channel è¯¦è§£ - é¸Ÿçª](https://colobu.com/2016/04/14/Golang-Channels/)

- [Go è¯­è¨€é€šé“ï¼ˆchanï¼‰â€”â€”goroutine ä¹‹é—´é€šä¿¡çš„ç®¡é“](http://c.biancheng.net/view/97.html)

- [ã€golangã€‘channel è¯¦è§£- SegmentFault æ€å¦](https://segmentfault.com/a/1190000023961580)

- [Golang ä½¿ç”¨ç³»åˆ—---- channel](https://kingjcy.github.io/post/golang/go-channel/)

- [go è¯­è¨€ä¸­çš„ channel ä¸åç¨‹é—´é€šä¿¡ - æœ‰æ‚Ÿ](https://youwu.today/skill/backend/golang-channel/)

- [channel Â· æ·±å…¥è§£æ Go](https://tiancaiamao.gitbooks.io/go-internals/content/zh/07.1.html)

- [go è¯­è¨€ä¹‹è¡Œ--golang æ ¸æ­¦å™¨ goroutine è°ƒåº¦åŸç†ã€channel è¯¦è§£](https://learnku.com/articles/41668)

- [ã€Golangã€‘ç±»å‹- Channel - è¥¿ç»´èœ€é»çš„åšå®¢](https://swsmile.info/post/golang-channel/)

- [Goè¯­è¨€ä¸­chennelä¸åç¨‹é—´é€šä¿¡](https://youwu.today/skill/backend/golang-channel/)
